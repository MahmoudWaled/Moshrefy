@{
    ViewData["Title"] = "Center Users";
    var centerId = ViewBag.CenterId as int? ?? 0;
    var centerName = ViewBag.CenterName as string ?? "Unknown Center";
    var centerAddress = ViewBag.CenterAddress as string ?? "";
}

<!-- Content Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>
                    <i class="fas fa-users"></i> @centerName - Users
                </h1>
                <p class="text-muted">
                    <i class="fas fa-map-marker-alt"></i> @centerAddress
                </p>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="Centers">Centers</a></li>
                    <li class="breadcrumb-item"><a asp-action="CenterDetails" asp-route-centerId="@centerId">@centerName</a></li>
                    <li class="breadcrumb-item active">Users</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card card-info">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i> Users in @centerName
                        </h3>
                        <div class="card-tools">
                            <a asp-action="CreateUserForCenter" asp-route-centerId="@centerId" class="btn btn-action-create btn-sm mr-2" title="Create New User for This Center">
                                <i class="fas fa-user-plus"></i> Create User
                            </a>
                            <a asp-action="CenterDetails" asp-route-centerId="@centerId" class="btn btn-tool" title="Back to Center Details">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Alert messages -->
                        @if (TempData["SuccessMessage"] != null)
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle"></i>
                                @TempData["SuccessMessage"]
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        }
                        @if (TempData["ErrorMessage"] != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-circle"></i>
                                @TempData["ErrorMessage"]
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        }

                        <div class="table-responsive">
                            <table id="centerUsersTable" class="table table-bordered table-hover table-striped">
                                <thead class="thead-light">
                                    <tr>
                                        <th>#</th>
                                        <th data-name="Name">Name</th>
                                        <th data-name="UserName">Username</th>
                                        <th data-name="Email">Email</th>
                                        <th data-name="PhoneNumber">Phone</th>
                                        <th data-name="RoleName">Role</th>
                                        <th data-name="IsActive">Status</th>
                                        <th data-name="IsDeleted">State</th>
                                        <th data-name="CreatedAt">Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a asp-action="CenterDetails" asp-route-centerId="@centerId" class="btn btn-default">
                            <i class="fas fa-arrow-left"></i> Back to Center Details
                        </a>
                        <a asp-action="Centers" class="btn btn-secondary">
                            <i class="fas fa-list"></i> All Centers
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">

    <!-- Custom CSS -->
    <style>
        #centerUsersTable {
            font-size: 0.9rem;
        }

        #centerUsersTable thead th {
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 8px;
            white-space: nowrap;
        }

        #centerUsersTable tbody td {
            padding: 10px 8px;
            vertical-align: middle !important;
        }

        #centerUsersTable .badge {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 4px 8px;
            white-space: nowrap;
        }

        #centerUsersTable tbody tr:hover {
            background-color: #f8f9fa !important;
        }
    </style>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            var centerId = @centerId;
            var isFirstLoad = true;

            // Initialize DataTable
            var table = $('#centerUsersTable').DataTable({
                processing: false,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetCenterUsersData", "SuperAdmin")',
                    type: 'POST',
                    data: function (d) {
                        d.centerId = centerId;
                    },
                    error: function (xhr, error, code) {
                        console.error('DataTables error:', error, code);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error Loading Data',
                            text: 'Please refresh the page and try again.',
                            timer: 3000
                        });
                    },
                    beforeSend: function () {
                        if (isFirstLoad) {
                            $('#centerUsersTable tbody').html(
                                '<tr><td colspan="10" class="text-center py-5">' +
                                '<div class="spinner-border text-info" role="status">' +
                                '<span class="sr-only">Loading...</span></div>' +
                                '<br><span class="text-muted mt-2">Loading users...</span>' +
                                '</td></tr>'
                            );
                        }
                    },
                    complete: function () {
                        isFirstLoad = false;
                    }
                },
                columns: [
                    {
                        data: null,
                        orderable: false,
                        searchable: false,
                        width: '40px',
                        className: 'text-center align-middle',
                        render: function (data, type, row, meta) {
                            return '<span class="text-muted">' + (meta.row + meta.settings._iDisplayStart + 1) + '</span>';
                        }
                    },
                    {
                        data: 'name',
                        name: 'Name',
                        width: '150px',
                        className: 'align-middle',
                        render: function (data) {
                            return '<i class="fas fa-user text-primary mr-1"></i> <strong>' + data + '</strong>';
                        }
                    },
                    {
                        data: 'userName',
                        name: 'UserName',
                        width: '120px',
                        className: 'align-middle',
                        render: function (data) {
                            return '<code>' + data + '</code>';
                        }
                    },
                    {
                        data: 'email',
                        name: 'Email',
                        width: '180px',
                        className: 'align-middle',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<a href="mailto:' + data + '" class="text-info">' + data + '</a>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'phoneNumber',
                        name: 'PhoneNumber',
                        width: '120px',
                        className: 'align-middle text-nowrap',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<i class="fas fa-phone text-success mr-1"></i> ' + data;
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'roleName',
                        name: 'RoleName',
                        width: '100px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                var badgeClass = 'badge-secondary';
                                var icon = 'fa-user';
                                
                                switch(data) {
                                    case 'SuperAdmin':
                                        badgeClass = 'badge-role-superadmin';
                                        icon = 'fa-user-shield';
                                        break;
                                    case 'Admin':
                                        badgeClass = 'badge-role-admin';
                                        icon = 'fa-user-tie';
                                        break;
                                    case 'Manager':
                                        badgeClass = 'badge-role-manager';
                                        icon = 'fa-user-cog';
                                        break;
                                    case 'Employee':
                                        badgeClass = 'badge-role-employee';
                                        icon = 'fa-user';
                                        break;
                                }
                                
                                return '<span class="badge ' + badgeClass + ' px-2">' +
                                       '<i class="fas ' + icon + '"></i> ' + data + '</span>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'isActive',
                        name: 'IsActive',
                        width: '85px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                return '<span class="badge badge-state-active px-2"><i class="fas fa-check-circle"></i> Active</span>';
                            }
                            return '<span class="badge badge-state-deactive px-2"><i class="fas fa-times-circle"></i> Inactive</span>';
                        }
                    },
                    {
                        data: 'isDeleted',
                        name: 'IsDeleted',
                        width: '85px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                return '<span class="badge badge-state-deleted px-2"><i class="fas fa-trash-alt"></i> Deleted</span>';
                            }
                            return '<span class="badge badge-state-normal px-2"><i class="fas fa-check"></i> Normal</span>';
                        }
                    },
                    {
                        data: 'createdAt',
                        name: 'CreatedAt',
                        width: '110px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            var date = new Date(data);
                            var formatted = date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            return '<small class="text-muted"><i class="fas fa-clock mr-1"></i>' + formatted + '</small>';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        width: '180px',
                        className: 'text-center align-middle',
                        render: function (data, type, row) {
                            var buttons = '<div class="btn-group btn-group-sm" role="group">';

                            // View button (always visible)
                            buttons += '<a href="@Url.Action("UserDetails", "SuperAdmin")/' + row.id + '" ' +
                                'class="btn btn-action-view" title="View Details">' +
                                '<i class="fas fa-eye"></i></a>';

                            if (!row.isDeleted) {
                                // Edit button
                                buttons += '<a href="@Url.Action("EditUser", "SuperAdmin")/' + row.id + '" ' +
                                    'class="btn btn-action-edit" title="Edit">' +
                                    '<i class="fas fa-edit"></i></a>';

                                // Active/Deactivate button
                                if (row.isActive) {
                                    buttons += '<button class="btn btn-state-deactive" title="Deactivate" ' +
                                        'onclick="deactivateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                        '<i class="fas fa-ban"></i></button>';
                                } else {
                                    buttons += '<button class="btn btn-state-active" title="Activate" ' +
                                        'onclick="activateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                        '<i class="fas fa-check"></i></button>';
                                }

                                // Delete dropdown button
                                buttons += '<div class="btn-group btn-group-sm" role="group">' +
                                    '<button type="button" class="btn btn-action-delete dropdown-toggle" ' +
                                    'data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Delete Options">' +
                                    '<i class="fas fa-trash"></i></button>' +
                                    '<div class="dropdown-menu dropdown-menu-right">' +
                                    '<a class="dropdown-item text-warning" href="#" ' +
                                    'onclick="event.preventDefault(); softDeleteUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="fas fa-trash-alt mr-2"></i>Soft Delete (Restorable)</a>' +
                                    '<div class="dropdown-divider"></div>' +
                                    '<a class="dropdown-item text-danger" href="#" ' +
                                    'onclick="event.preventDefault(); hardDeleteUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="fas fa-trash mr-2"></i>Hard Delete (Permanent)</a>' +
                                    '</div></div>';
                            } else {
                                // Restore button
                                buttons += '<button class="btn btn-state-restore" title="Restore" ' +
                                    'onclick="restoreUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="fas fa-undo"></i></button>';
                            }

                            buttons += '</div>';
                            return buttons;
                        }
                    }
                ],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                order: [[7, 'desc']], // Sort by created date descending
                autoWidth: false,
                responsive: true,
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search users...",
                    lengthMenu: "Show _MENU_ users",
                    info: "Showing _START_ to _END_ of _TOTAL_ users",
                    infoEmpty: "No users to display",
                    infoFiltered: "(filtered from _MAX_ total)",
                    zeroRecords: "No matching users found",
                    emptyTable: '<div class="p-4 text-center">' +
                        '<i class="fas fa-users fa-4x text-muted mb-3"></i>' +
                        '<h4 class="text-muted">No Users in This Center</h4>' +
                        '<p class="text-muted">This center doesn\'t have any users yet.</p></div>'
                },
                createdRow: function (row, data, dataIndex) {
                    if (data.isDeleted) {
                        $(row).addClass('table-danger');
                    }
                }
            });
        });

        // User action functions
        function restoreUser(userId, userName) {
            Swal.fire({
                title: 'Restore User?',
                html: 'Restore<br><strong>' + userName + '</strong>?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-undo"></i> Yes, Restore',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("RestoreUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Restored!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#centerUsersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        function activateUser(userId, userName) {
            Swal.fire({
                title: 'Activate User?',
                html: 'Activate<br><strong>' + userName + '</strong>?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-check"></i> Yes, Activate',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("ActivateUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Activated!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#centerUsersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        function deactivateUser(userId, userName) {
            Swal.fire({
                title: 'Deactivate User?',
                html: 'Deactivate<br><strong>' + userName + '</strong>?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-ban"></i> Yes, Deactivate',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("DeactivateUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deactivated!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#centerUsersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        function softDeleteUser(userId, userName) {
            Swal.fire({
                title: 'Soft Delete User?',
                html: 'Move<br><strong>' + userName + '</strong><br>to trash?<br><small class="text-muted">You can restore it later.</small>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-trash-alt"></i> Yes, Soft Delete',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("SoftDeleteUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleted!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#centerUsersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        function hardDeleteUser(userId, userName) {
            Swal.fire({
                title: 'Permanently Delete User?',
                html: '<strong class="text-danger">?? WARNING</strong><br>' +
                      'This will <strong>PERMANENTLY DELETE</strong><br>' +
                      '<strong>' + userName + '</strong><br><br>' +
                      '<span class="text-danger">This action CANNOT be undone!</span><br>' +
                      '<small class="text-muted">All user data will be lost forever.</small>',
                icon: 'error',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-trash"></i> Yes, DELETE PERMANENTLY',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("HardDeleteUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Permanently Deleted!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#centerUsersTable').DataTable().ajax.reload(null, false);
                }
            });
        }
    </script>
}
