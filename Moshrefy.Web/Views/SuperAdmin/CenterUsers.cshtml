@{
    ViewData["Title"] = "Center Users";
    var centerId = ViewBag.CenterId as int? ?? 0;
    var centerName = ViewBag.CenterName as string ?? "Unknown Center";
    var centerAddress = ViewBag.CenterAddress as string ?? "";
}

<!-- Page Header -->
<div class="page-header-modern">
    <div class="row g-2 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb-modern">
                    <li class="breadcrumb-item">
                        <a asp-controller="SuperAdmin" asp-action="Index"><i class="ti ti-home"></i> Dashboard</a>
                        <i class="ti ti-chevron-right breadcrumb-separator ms-2"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="SuperAdmin" asp-action="Centers">Centers</a>
                        <i class="ti ti-chevron-right breadcrumb-separator ms-2"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="SuperAdmin" asp-action="CenterDetails" asp-route-centerId="@centerId">@centerName</a>
                        <i class="ti ti-chevron-right breadcrumb-separator ms-2"></i>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Users</li>
                </ol>
            </nav>
            <h2 class="page-title"><i class="ti ti-users"></i> @centerName - Users</h2>
        </div>
        <div class="col-auto ms-auto d-print-none">
            <div class="btn-list">
                <a asp-action="CreateUserForCenter" asp-route-centerId="@centerId" class="btn btn-action-create d-none d-sm-inline-block">
                    <i class="ti ti-user-plus icon"></i> Create User
                </a>
                <button type="button" onclick="goBack()" class="btn d-none d-sm-inline-block">
                    <i class="ti ti-arrow-left icon"></i> Back
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Users in @centerName</h3>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="centerUsersTable" class="table table-vcenter table-hover">
                <thead>
                  <tr>
                    <th>#</th>
                    <th data-name="Name">Name</th>
                    <th data-name="UserName">Username</th>
                    <th data-name="PhoneNumber">Phone</th>
                    <th data-name="RoleName">Role</th>
                    <th data-name="IsActive">Status</th>
                    <th data-name="IsDeleted">State</th>
                    <th data-name="CreatedAt">Created</th>
                    <th class="w-1">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          <div class="card-footer">
            <button type="button" onclick="goBack()" class="btn btn-secondary">
              <i class="ti ti-arrow-left"></i> Back
            </button>
            <a asp-action="Centers" class="btn btn-outline-secondary">
              <i class="ti ti-list"></i> All Centers
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '@Url.Action("Centers", "SuperAdmin")';
            }
        }
        
        $(document).ready(function () {
            var centerId = @centerId;

            var table = $('#centerUsersTable').DataTable({
                processing: false,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetCenterUsersData", "SuperAdmin")',
                    type: 'POST',
                    data: function (d) { d.centerId = centerId; },
                    error: function (xhr, error, code) {
                        Swal.fire({ icon: 'error', title: 'Error Loading Data', text: 'Please refresh the page.', timer: 3000 });
                    }
                },
                columns: [
                    { data: null, orderable: false, searchable: false, className: 'text-center', render: function (d, t, r, m) { return '<span class="text-muted">' + (m.row + m.settings._iDisplayStart + 1) + '</span>'; } },
                    { data: 'name', name: 'Name', render: function (d) { return '<i class="ti ti-user text-primary me-1"></i> <strong>' + d + '</strong>'; } },
                    { data: 'userName', name: 'UserName', render: function (d) { return '<code>' + d + '</code>'; } },
                    { data: 'phoneNumber', name: 'PhoneNumber', render: function (d) { return d ? '<i class="ti ti-phone text-success me-1"></i>' + d : '<span class="text-muted">N/A</span>'; } },
                    {
                        data: 'roleName', name: 'RoleName', className: 'text-center',
                        render: function (d) {
                            return '<span class="text-muted">' + d + '</span>';
                        }
                    },
                    { data: 'isActive', name: 'IsActive', className: 'text-center', render: function (d, t, row) { if (row.isDeleted) return '<span class="text-muted">Inactive</span>'; return d ? '<span class="text-muted">Active</span>' : '<span class="badge bg-state-inactive text-white"><i class="ti ti-x"></i> Inactive</span>'; } },
                    { data: 'isDeleted', name: 'IsDeleted', className: 'text-center', render: function (d) { return d ? '<span class="badge bg-danger text-white"><i class="ti ti-trash"></i> Deleted</span>' : '<span class="text-muted">Normal</span>'; } },
                    { data: 'createdAt', name: 'CreatedAt', className: 'text-center', render: function (d) { return '<small class="text-muted"><i class="ti ti-clock me-1"></i>' + new Date(d).toLocaleDateString() + '</small>'; } },
                    {
                        data: null, orderable: false, className: 'text-center',
                        render: function (d, t, row) {
                            var b = '<div class="btn-group btn-group-sm">';
                            b += '<a href="@Url.Action("UserDetails", "SuperAdmin")/' + row.id + '" class="btn btn-action-view" title="View"><i class="ti ti-eye"></i></a>';
                            if (!row.isDeleted) {
                                b += '<a href="@Url.Action("EditUser", "SuperAdmin")/' + row.id + '" class="btn btn-action-edit" title="Edit"><i class="ti ti-edit"></i></a>';
                                if (row.isActive) {
                                    b += '<button class="btn btn-state-deactive" title="Deactivate" onclick="deactivateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')"><i class="ti ti-ban"></i></button>';
                                } else {
                                    b += '<button class="btn btn-state-active" title="Activate" onclick="activateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')"><i class="ti ti-check"></i></button>';
                                }
                                b += '<button class="btn btn-action-delete" title="Delete" onclick="softDeleteUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')"><i class="ti ti-trash"></i></button>';
                            } else {
                                b += '<button class="btn btn-state-restore" title="Restore" onclick="restoreUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')"><i class="ti ti-refresh"></i></button>';
                            }
                            return b + '</div>';
                        }
                    }
                ],
                pageLength: 25, order: [[7, 'desc']],
                language: {
                    search: '_INPUT_',
                    searchPlaceholder: 'Search users...',
                    lengthMenu: '_MENU_ entries',
                    info: 'Showing _START_ to _END_ of _TOTAL_ users',
                    infoEmpty: 'No users found',
                    infoFiltered: '(from _MAX_ total)',
                    zeroRecords: 'No matching users found',
                    paginate: { first: '«', last: '»', next: '›', previous: '‹' }
                },
                createdRow: function (row, data) { if (data.isDeleted) $(row).addClass('table-danger'); }
            });
        });

        function restoreUser(userId, userName) {
            Swal.fire({ title: 'Restore User?', html: 'Restore <strong>' + userName + '</strong>?', icon: 'question', showCancelButton: true, confirmButtonColor: '#28a745', confirmButtonText: '<i class="ti ti-refresh"></i> Yes, Restore' })
            .then(function (r) { if (r.isConfirmed) { $.post('@Url.Action("RestoreUser", "SuperAdmin")', { id: userId }).done(function (res) { if (res.success) { Swal.fire({ icon: 'success', title: 'Restored!', timer: 2000, showConfirmButton: false }); $('#centerUsersTable').DataTable().ajax.reload(); } }); } });
        }

        function activateUser(userId, userName) {
            Swal.fire({ title: 'Activate User?', html: 'Activate <strong>' + userName + '</strong>?', icon: 'question', showCancelButton: true, confirmButtonColor: '#28a745', confirmButtonText: '<i class="ti ti-check"></i> Yes, Activate' })
            .then(function (r) { if (r.isConfirmed) { $.post('@Url.Action("ActivateUser", "SuperAdmin")', { id: userId }).done(function (res) { if (res.success) { Swal.fire({ icon: 'success', title: 'Activated!', timer: 2000, showConfirmButton: false }); $('#centerUsersTable').DataTable().ajax.reload(); } }); } });
        }

        function deactivateUser(userId, userName) {
            Swal.fire({ title: 'Deactivate User?', html: 'Deactivate <strong>' + userName + '</strong>?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ffc107', confirmButtonText: '<i class="ti ti-ban"></i> Yes, Deactivate' })
            .then(function (r) { if (r.isConfirmed) { $.post('@Url.Action("DeactivateUser", "SuperAdmin")', { id: userId }).done(function (res) { if (res.success) { Swal.fire({ icon: 'success', title: 'Deactivated!', timer: 2000, showConfirmButton: false }); $('#centerUsersTable').DataTable().ajax.reload(); } }); } });
        }

        function softDeleteUser(userId, userName) {
            Swal.fire({ title: 'Delete User?', html: 'Move <strong>' + userName + '</strong> to trash?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: '<i class="ti ti-trash"></i> Yes, Delete' })
            .then(function (r) { if (r.isConfirmed) { $.post('@Url.Action("SoftDeleteUser", "SuperAdmin")', { id: userId }).done(function (res) { if (res.success) { Swal.fire({ icon: 'success', title: 'Deleted!', timer: 2000, showConfirmButton: false }); $('#centerUsersTable').DataTable().ajax.reload(); } }); } });
        }
    </script>
}
