@{
    ViewData["Title"] = "Search Users";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page header -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">Users</div>
        <h2 class="page-title"><i class="ti ti-search"></i> Search Users</h2>
      </div>
    </div>
  </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">
      <!-- Search by Email -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="ti ti-mail me-2"></i>Search by Email</h3>
          </div>
          <div class="card-body">
            <form id="searchByEmailForm">
              <div class="mb-3">
                <label class="form-label"><i class="ti ti-at me-1"></i>Email Address</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="ti ti-mail"></i></span>
                  <input type="email" class="form-control" id="emailInput" name="email" placeholder="Enter email address..." required>
                </div>
                <small class="form-hint"><i class="ti ti-info-circle me-1"></i>Enter the exact email address</small>
              </div>
              <button type="submit" class="btn btn-action-view w-100"><i class="ti ti-search"></i> Search by Email</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Search by Username -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="ti ti-user me-2"></i>Search by Username</h3>
          </div>
          <div class="card-body">
            <form id="searchByUsernameForm">
              <div class="mb-3">
                <label class="form-label"><i class="ti ti-tag me-1"></i>Username</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="ti ti-user"></i></span>
                  <input type="text" class="form-control" id="usernameInput" name="username" placeholder="Enter username..." required>
                </div>
                <small class="form-hint"><i class="ti ti-info-circle me-1"></i>Enter the exact username</small>
              </div>
              <button type="submit" class="btn btn-action-view w-100"><i class="ti ti-search"></i> Search by Username</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Results -->
    <div id="searchResults" style="display:none" class="mt-4">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="ti ti-search me-2"></i>Search Result</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <div class="datagrid">
                <div class="datagrid-item"><div class="datagrid-title"><i class="ti ti-user text-primary me-1"></i>Name</div><div class="datagrid-content"><strong id="resultName"></strong></div></div>
                <div class="datagrid-item"><div class="datagrid-title"><i class="ti ti-at text-info me-1"></i>Username</div><div class="datagrid-content"><code id="resultUsername"></code></div></div>
                <div class="datagrid-item"><div class="datagrid-title"><i class="ti ti-mail text-info me-1"></i>Email</div><div class="datagrid-content" id="resultEmail"></div></div>
                <div class="datagrid-item"><div class="datagrid-title"><i class="ti ti-phone text-success me-1"></i>Phone</div><div class="datagrid-content" id="resultPhone"></div></div>
                <div class="datagrid-item"><div class="datagrid-title"><i class="ti ti-building text-warning me-1"></i>Center</div><div class="datagrid-content" id="resultCenter"></div></div>
                <div class="datagrid-item"><div class="datagrid-title"><i class="ti ti-tag text-purple me-1"></i>Role</div><div class="datagrid-content" id="resultRole"></div></div>
                <div class="datagrid-item"><div class="datagrid-title"><i class="ti ti-toggle-right text-success me-1"></i>Status</div><div class="datagrid-content" id="resultStatus"></div></div>
                <div class="datagrid-item"><div class="datagrid-title"><i class="ti ti-info-circle text-info me-1"></i>State</div><div class="datagrid-content" id="resultState"></div></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-success-lt">
                <div class="card-header"><h3 class="card-title"><i class="ti ti-settings me-2"></i>Actions</h3></div>
                <div class="card-body">
                  <div class="d-grid gap-2" id="resultActions"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('#searchByEmailForm').on('submit', function (e) {
                e.preventDefault();
                const email = $('#emailInput').val().trim();
                if (!email) { Swal.fire('Error', 'Please enter an email address', 'error'); return; }
                Swal.fire({ title: 'Searching...', html: 'Looking for: <strong>' + email + '</strong>', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                $.post('@Url.Action("SearchUserByEmail")', { email: email }).done(function (res) { Swal.close(); if (res.success) { displayUserResult(res.user); } else { Swal.fire({ icon: 'error', title: 'Not Found', html: res.message }); } });
            });

            $('#searchByUsernameForm').on('submit', function (e) {
                e.preventDefault();
                const username = $('#usernameInput').val().trim();
                if (!username) { Swal.fire('Error', 'Please enter a username', 'error'); return; }
                Swal.fire({ title: 'Searching...', html: 'Looking for: <strong>' + username + '</strong>', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                $.post('@Url.Action("SearchUserByUsername")', { username: username }).done(function (res) { Swal.close(); if (res.success) { displayUserResult(res.user); } else { Swal.fire({ icon: 'error', title: 'Not Found', html: res.message }); } });
            });

            function displayUserResult(user) {
                $('#searchResults').fadeIn();
                $('#resultName').text(user.name);
                $('#resultUsername').text(user.userName);
                $('#resultEmail').html(user.email ? '<a href="mailto:' + user.email + '">' + user.email + '</a>' : '<span class="text-muted">N/A</span>');
                $('#resultPhone').html(user.phoneNumber ? '<a href="tel:' + user.phoneNumber + '">' + user.phoneNumber + '</a>' : '<span class="text-muted">N/A</span>');
                $('#resultCenter').html(user.centerName && user.centerId ? '<a href="@Url.Action("CenterDetails")/' + user.centerId + '" class="badge bg-info"><i class="ti ti-building me-1"></i>' + user.centerName + '</a>' : '<span class="text-muted">No center</span>');
                
                var roleIcon = user.roleName === 'SuperAdmin' ? 'ti-shield' : user.roleName === 'Admin' ? 'ti-tie' : user.roleName === 'Manager' ? 'ti-settings' : 'ti-user';
                var roleBg = user.roleName === 'SuperAdmin' ? 'bg-role-superadmin' : user.roleName === 'Admin' ? 'bg-role-admin' : user.roleName === 'Manager' ? 'bg-role-manager' : 'bg-role-employee';
                $('#resultRole').html(user.roleName ? '<span class="badge ' + roleBg + '"><i class="ti ' + roleIcon + ' me-1"></i>' + user.roleName + '</span>' : '<span class="text-muted">N/A</span>');
                $('#resultStatus').html(user.isActive ? '<span class="badge bg-state-active"><i class="ti ti-check"></i> Active</span>' : '<span class="badge bg-state-inactive"><i class="ti ti-x"></i> Inactive</span>');
                $('#resultState').html(user.isDeleted ? '<span class="badge bg-action-delete"><i class="ti ti-trash"></i> Deleted</span>' : '<span class="badge bg-state-active"><i class="ti ti-check"></i> Normal</span>');
                
                var actions = '<a href="@Url.Action("UserDetails")/' + user.id + '" class="btn btn-action-view"><i class="ti ti-eye"></i> View Details</a>';
                if (!user.isDeleted) {
                    actions += '<a href="@Url.Action("EditUser")/' + user.id + '" class="btn btn-action-edit"><i class="ti ti-edit"></i> Edit User</a>';
                    actions += '<a href="@Url.Action("UpdateUserRole")/' + user.id + '" class="btn btn-purple"><i class="ti ti-tag"></i> Update Role</a>';
                }
                $('#resultActions').html(actions);
                $('html, body').animate({ scrollTop: $('#searchResults').offset().top - 100 }, 500);
            }
        });
    </script>
    <style>.bg-purple,.btn-purple{background-color:#6f42c1!important;color:white;}.btn-purple:hover{background-color:#5a32a3!important;}</style>
}
