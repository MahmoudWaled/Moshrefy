@{
    ViewData["Title"] = "User Management";
}

<!-- Page header -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <!-- Page pre-title -->
        <div class="page-pretitle">
          Management
        </div>
        <h2 class="page-title">
          Users
        </h2>
      </div>
      <!-- Page title actions -->
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a asp-action="SearchUsers" class="btn btn-action-view d-none d-sm-inline-block" title="Advanced Search">
            <i class="ti ti-search icon"></i>
            Search Users
          </a>
          <a asp-action="InactiveUsers" class="btn btn-state-deactive d-none d-sm-inline-block" title="View Inactive Users">
            <i class="ti ti-user-off icon"></i>
            Inactive Users
          </a>
          <a asp-action="CreateCenterAdmin" class="btn btn-role-admin d-none d-sm-inline-block">
            <i class="ti ti-shield icon"></i>
            Create Center Admin
          </a>
          <a asp-action="CreateUserForCenter" class="btn btn-action-create d-none d-sm-inline-block">
            <i class="ti ti-user-plus icon"></i>
            Create User
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">All Users</h3>
            <div class="ms-auto">
              <!-- Filter Controls -->
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm active" id="showAll">
                  <i class="ti ti-list icon"></i> All
                </button>
                <button type="button" class="btn btn-sm" id="hideDeleted">
                  <i class="ti ti-filter icon"></i> Active
                </button>
                <button type="button" class="btn btn-sm" id="showDeleted">
                  <i class="ti ti-trash icon"></i> Deleted
                </button>
              </div>
              <select id="roleFilter" class="form-select form-select-sm d-inline-block ms-2" style="width: auto;">
                <option value="all">All Roles</option>
                <option value="SuperAdmin">Super Admin</option>
                <option value="Admin">Admin</option>
                <option value="Manager">Manager</option>
                <option value="Employee">Employee</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="usersTable" class="table table-vcenter table-hover">
                <thead>
                  <tr>
                    <th>#</th>
                    <th data-name="Name">Name</th>
                    <th data-name="UserName">Username</th>
                    <th data-name="Email">Email</th>
                    <th data-name="PhoneNumber">Phone</th>
                    <th data-name="CenterName">Center</th>
                    <th data-name="RoleName">Role</th>
                    <th data-name="IsActive">Status</th>
                    <th data-name="IsDeleted">State</th>
                    <th data-name="CreatedAt">Created</th>
                    <th class="w-1">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Data loaded via AJAX -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var currentFilter = 'all';
            var currentRole = 'all';
            var isFirstLoad = true;

            // Initialize DataTable with server-side processing
            var table = $('#usersTable').DataTable({
                processing: false,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetUsersData", "SuperAdmin")',
                    type: 'POST',
                    data: function (d) {
                        d.filterDeleted = currentFilter;
                        d.filterRole = currentRole;
                    },
                    error: function (xhr, error, code) {
                        console.error('DataTables error:', error, code);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error Loading Data',
                            text: 'Please refresh the page and try again.',
                            timer: 3000
                        });
                    }
                },
                columns: [
                    {
                        data: null,
                        orderable: false,
                        searchable: false,
                        width: '40px',
                        className: 'text-center align-middle',
                        render: function (data, type, row, meta) {
                            return '<span class="text-muted">' + (meta.row + meta.settings._iDisplayStart + 1) + '</span>';
                        }
                    },
                    {
                        data: 'name',
                        name: 'Name',
                        width: '150px',
                        className: 'align-middle',
                        render: function (data) {
                            return '<i class="ti ti-user text-primary me-1"></i> <strong>' + data + '</strong>';
                        }
                    },
                    {
                        data: 'userName',
                        name: 'UserName',
                        width: '120px',
                        className: 'align-middle',
                        render: function (data) {
                            return '<code>' + data + '</code>';
                        }
                    },
                    {
                        data: 'email',
                        name: 'Email',
                        width: '180px',
                        className: 'align-middle',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<a href="mailto:' + data + '" class="text-info">' + data + '</a>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'phoneNumber',
                        name: 'PhoneNumber',
                        width: '120px',
                        className: 'align-middle text-nowrap',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<i class="ti ti-phone text-success me-1"></i> ' + data;
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'centerName',
                        name: 'CenterName',
                        width: '150px',
                        className: 'align-middle',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<i class="ti ti-building text-info me-1"></i> <small>' + data + '</small>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'roleName',
                        name: 'RoleName',
                        width: '100px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                var badgeClass = 'bg-secondary';
                                var icon = 'ti-user';
                                
                                switch(data) {
                                    case 'SuperAdmin':
                                        badgeClass = 'bg-role-superadmin';
                                        icon = 'ti-shield';
                                        break;
                                    case 'Admin':
                                        badgeClass = 'bg-role-admin';
                                        icon = 'ti-user-check';
                                        break;
                                    case 'Manager':
                                        badgeClass = 'bg-role-manager';
                                        icon = 'ti-user-cog';
                                        break;
                                    case 'Employee':
                                        badgeClass = 'bg-role-employee';
                                        icon = 'ti-user';
                                        break;
                                }
                                
                                return '<span class="badge ' + badgeClass + '">' +
                                       '<i class="ti ' + icon + '"></i> ' + data + '</span>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'isActive',
                        name: 'IsActive',
                        width: '85px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                return '<span class="badge bg-state-active"><i class="ti ti-check"></i> Active</span>';
                            }
                            return '<span class="badge bg-state-inactive"><i class="ti ti-x"></i> Inactive</span>';
                        }
                    },
                    {
                        data: 'isDeleted',
                        name: 'IsDeleted',
                        width: '85px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                return '<span class="badge bg-action-delete"><i class="ti ti-trash"></i> Deleted</span>';
                            }
                            return '<span class="badge bg-state-active"><i class="ti ti-check"></i> Normal</span>';
                        }
                    },
                    {
                        data: 'createdAt',
                        name: 'CreatedAt',
                        width: '110px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            var date = new Date(data);
                            var formatted = date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            return '<small class="text-muted"><i class="ti ti-clock me-1"></i>' + formatted + '</small>';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        width: '180px',
                        className: 'text-center align-middle',
                        render: function (data, type, row) {
                            var buttons = '<div class="btn-group btn-group-sm" role="group">';

                            // View button (always visible)
                            buttons += '<a href="@Url.Action("UserDetails", "SuperAdmin")/' + row.id + '" ' +
                                'class="btn btn-action-view" title="View Details">' +
                                '<i class="ti ti-eye"></i></a>';

                            if (!row.isDeleted) {
                                // Edit button
                                buttons += '<a href="@Url.Action("EditUser", "SuperAdmin")/' + row.id + '" ' +
                                    'class="btn btn-action-edit" title="Edit">' +
                                    '<i class="ti ti-edit"></i></a>';

                                // Active/Deactivate button
                                if (row.isActive) {
                                    buttons += '<button class="btn btn-state-deactive" title="Deactivate" ' +
                                        'onclick="deactivateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                        '<i class="ti ti-ban"></i></button>';
                                } else {
                                    buttons += '<button class="btn btn-state-active" title="Activate" ' +
                                        'onclick="activateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                        '<i class="ti ti-check"></i></button>';
                                }

                                // Delete button
                                buttons += '<button class="btn btn-action-delete" title="Delete" ' +
                                    'onclick="softDeleteUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="ti ti-trash"></i></button>';
                            } else {
                                // Restore button
                                buttons += '<button class="btn btn-state-restore" title="Restore" ' +
                                    'onclick="restoreUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="ti ti-refresh"></i></button>';
                            }

                            buttons += '</div>';
                            return buttons;
                        }
                    }
                ],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                order: [[9, 'desc']], // Sort by created date descending
                autoWidth: false,
                responsive: true,
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search users...",
                    lengthMenu: "Show _MENU_ users",
                    info: "Showing _START_ to _END_ of _TOTAL_ users",
                    infoEmpty: "No users to display",
                    infoFiltered: "(filtered from _MAX_ total)",
                    zeroRecords: "No matching users found",
                    emptyTable: '<div class="p-4 text-center">' +
                        '<i class="ti ti-users" style="font-size: 4rem;"></i>' +
                        '<h4 class="text-muted mt-3">No Users Found</h4>' +
                        '<p class="text-muted">Get started by creating your first user.</p>' +
                        '<a href="@Url.Action("CreateUserForCenter", "SuperAdmin")" class="btn btn-action-create">' +
                        '<i class="ti ti-plus"></i> Create Your First User</a></div>'
                },
                createdRow: function (row, data, dataIndex) {
                    if (data.isDeleted) {
                        $(row).addClass('table-danger');
                    }
                }
            });

            // Filter: Show All
            $('#showAll').click(function () {
                currentFilter = 'all';
                $('.btn-group .btn').removeClass('active');
                $(this).addClass('active');
                table.ajax.reload(null, false);
            });

            // Filter: Active Only
            $('#hideDeleted').click(function () {
                currentFilter = 'active';
                $('.btn-group .btn').removeClass('active');
                $(this).addClass('active');
                table.ajax.reload(null, false);
            });

            // Filter: Show Only Deleted
            $('#showDeleted').click(function () {
                currentFilter = 'deleted';
                $('.btn-group .btn').removeClass('active');
                $(this).addClass('active');
                table.ajax.reload(null, false);
            });

            // Role Filter
            $('#roleFilter').change(function () {
                currentRole = $(this).val();
                table.ajax.reload(null, false);
            });
        });

        // Restore user function
        function restoreUser(userId, userName) {
            Swal.fire({
                title: 'Restore User?',
                html: 'Are you sure you want to restore<br><strong>' + userName + '</strong>?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ti ti-refresh"></i> Yes, Restore',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("RestoreUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Restored!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        // Activate user function
        function activateUser(userId, userName) {
            Swal.fire({
                title: 'Activate User?',
                html: 'Activate user<br><strong>' + userName + '</strong>?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ti ti-check"></i> Yes, Activate',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("ActivateUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Activated!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        // Deactivate user function
        function deactivateUser(userId, userName) {
            Swal.fire({
                title: 'Deactivate User?',
                html: 'Deactivate user<br><strong>' + userName + '</strong>?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ti ti-ban"></i> Yes, Deactivate',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("DeactivateUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deactivated!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        // Soft delete user function
        function softDeleteUser(userId, userName) {
            Swal.fire({
                title: 'Delete User?',
                html: 'Move <strong>' + userName + '</strong> to trash?<br><small class="text-muted">You can restore it later.</small>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ti ti-trash"></i> Yes, Delete',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("SoftDeleteUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleted!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }
    </script>
}
