@{
    ViewData["Title"] = "User Management";
}

<!-- Content Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>
                    <i class="fas fa-users-cog"></i> User Management
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item active">Users</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list"></i> All Users
                        </h3>
                        <div class="card-tools">
                            <div class="btn-group">
                                <a asp-action="SearchUsers" class="btn btn-action-view btn-sm" title="Advanced Search">
                                    <i class="fas fa-search"></i> Search Users
                                </a>
                                <a asp-action="InactiveUsers" class="btn btn-state-deactive btn-sm" title="View Inactive Users">
                                    <i class="fas fa-user-times"></i> Inactive Users
                                </a>
                                <a asp-action="CreateCenterAdmin" class="btn btn-role-admin btn-sm">
                                    <i class="fas fa-user-shield"></i> Create Center Admin
                                </a>
                                <a asp-action="CreateUserForCenter" class="btn btn-action-create btn-sm">
                                    <i class="fas fa-user-plus"></i> Create User
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Alert messages -->
                        @if (TempData["SuccessMessage"] != null)
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle"></i>
                                @TempData["SuccessMessage"]
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        }
                        @if (TempData["ErrorMessage"] != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-circle"></i>
                                @TempData["ErrorMessage"]
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        }

                        <!-- Filter Controls -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                                    <label class="btn btn-outline-primary active" id="showAll">
                                        <input type="radio" name="filterOptions" checked>
                                        <i class="fas fa-list"></i> Show All
                                    </label>
                                    <label class="btn btn-outline-success" id="hideDeleted">
                                        <input type="radio" name="filterOptions">
                                        <i class="fas fa-filter"></i> Active Only
                                    </label>
                                    <label class="btn btn-outline-danger" id="showDeleted">
                                        <input type="radio" name="filterOptions">
                                        <i class="fas fa-trash"></i> Show Only Deleted
                                    </label>
                                </div>
                                <span class="ml-3 text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    <span id="filterInfo">Showing all users</span>
                                </span>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-0">
                                    <label for="roleFilter" class="mr-2">
                                        <i class="fas fa-user-tag"></i> Filter by Role:
                                    </label>
                                    <select id="roleFilter" class="form-control d-inline-block role-filter-select">
                                        <option value="all">All Roles</option>
                                        <option value="SuperAdmin">Super Admin</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Employee">Employee</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table id="usersTable" class="table table-bordered table-hover table-striped">
                                <thead class="thead-light">
                                    <tr>
                                        <th>#</th>
                                        <th data-name="Name">Name</th>
                                        <th data-name="UserName">Username</th>
                                        <th data-name="Email">Email</th>
                                        <th data-name="PhoneNumber">Phone</th>
                                        <th data-name="CenterName">Center</th>
                                        <th data-name="RoleName">Role</th>
                                        <th data-name="IsActive">Status</th>
                                        <th data-name="IsDeleted">State</th>
                                        <th data-name="CreatedAt">Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">

    <!-- Custom CSS for better table appearance -->

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            var currentFilter = 'all';
            var currentRole = 'all';
            var isFirstLoad = true;

            // Initialize DataTable with server-side processing
            var table = $('#usersTable').DataTable({
                processing: false,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetUsersData", "SuperAdmin")',
                    type: 'POST',
                    data: function (d) {
                        d.filterDeleted = currentFilter;
                        d.filterRole = currentRole;
                    },
                    error: function (xhr, error, code) {
                        console.error('DataTables error:', error, code);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error Loading Data',
                            text: 'Please refresh the page and try again.',
                            timer: 3000
                        });
                    },
                    beforeSend: function () {
                        if (isFirstLoad) {
                            $('#usersTable tbody').html(
                                '<tr><td colspan="11" class="text-center py-5">' +
                                '<div class="spinner-border text-primary" role="status">' +
                                '<span class="sr-only">Loading...</span></div>' +
                                '<br><span class="text-muted mt-2">Loading users...</span>' +
                                '</td></tr>'
                            );
                        }
                    },
                    complete: function () {
                        isFirstLoad = false;
                    }
                },
                columns: [
                    {
                        data: null,
                        orderable: false,
                        searchable: false,
                        width: '40px',
                        className: 'text-center align-middle',
                        render: function (data, type, row, meta) {
                            return '<span class="text-muted">' + (meta.row + meta.settings._iDisplayStart + 1) + '</span>';
                        }
                    },
                    {
                        data: 'name',
                        name: 'Name',
                        width: '150px',
                        className: 'align-middle',
                        render: function (data) {
                            return '<i class="fas fa-user text-primary mr-1"></i> <strong>' + data + '</strong>';
                        }
                    },
                    {
                        data: 'userName',
                        name: 'UserName',
                        width: '120px',
                        className: 'align-middle',
                        render: function (data) {
                            return '<code>' + data + '</code>';
                        }
                    },
                    {
                        data: 'email',
                        name: 'Email',
                        width: '180px',
                        className: 'align-middle',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<a href="mailto:' + data + '" class="text-info">' + data + '</a>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'phoneNumber',
                        name: 'PhoneNumber',
                        width: '120px',
                        className: 'align-middle text-nowrap',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<i class="fas fa-phone text-success mr-1"></i> ' + data;
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'centerName',
                        name: 'CenterName',
                        width: '150px',
                        className: 'align-middle',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<i class="fas fa-building text-info mr-1"></i> <small>' + data + '</small>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'roleName',
                        name: 'RoleName',
                        width: '100px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                var badgeClass = 'badge-secondary';
                                var icon = 'fa-user';
                                
                                switch(data) {
                                    case 'SuperAdmin':
                                        badgeClass = 'badge-role-superadmin';
                                        icon = 'fa-user-shield';
                                        break;
                                    case 'Admin':
                                        badgeClass = 'badge-role-admin';
                                        icon = 'fa-user-tie';
                                        break;
                                    case 'Manager':
                                        badgeClass = 'badge-role-manager';
                                        icon = 'fa-user-cog';
                                        break;
                                    case 'Employee':
                                        badgeClass = 'badge-role-employee';
                                        icon = 'fa-user';
                                        break;
                                }
                                
                                return '<span class="badge ' + badgeClass + ' px-2">' +
                                       '<i class="fas ' + icon + '"></i> ' + data + '</span>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'isActive',
                        name: 'IsActive',
                        width: '85px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                return '<span class="badge badge-state-active px-2"><i class="fas fa-check-circle"></i> Active</span>';
                            }
                            return '<span class="badge badge-state-deactive px-2"><i class="fas fa-times-circle"></i> Inactive</span>';
                        }
                    },
                    {
                        data: 'isDeleted',
                        name: 'IsDeleted',
                        width: '85px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                return '<span class="badge badge-state-deleted px-2"><i class="fas fa-trash-alt"></i> Deleted</span>';
                            }
                            return '<span class="badge badge-state-normal px-2"><i class="fas fa-check"></i> Normal</span>';
                        }
                    },
                    {
                        data: 'createdAt',
                        name: 'CreatedAt',
                        width: '110px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            var date = new Date(data);
                            var formatted = date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            return '<small class="text-muted"><i class="fas fa-clock mr-1"></i>' + formatted + '</small>';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        width: '180px',
                        className: 'text-center align-middle',
                        render: function (data, type, row) {
                            var buttons = '<div class="btn-group btn-group-sm" role="group">';

                            // View button (always visible)
                            buttons += '<a href="@Url.Action("UserDetails", "SuperAdmin")/' + row.id + '" ' +
                                'class="btn btn-action-view" title="View Details">' +
                                '<i class="fas fa-eye"></i></a>';

                            if (!row.isDeleted) {
                                // Edit button
                                buttons += '<a href="@Url.Action("EditUser", "SuperAdmin")/' + row.id + '" ' +
                                    'class="btn btn-action-edit" title="Edit">' +
                                    '<i class="fas fa-edit"></i></a>';

                                // Active/Deactivate button
                                if (row.isActive) {
                                    buttons += '<button class="btn btn-state-deactive" title="Deactivate" ' +
                                        'onclick="deactivateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                        '<i class="fas fa-ban"></i></button>';
                                } else {
                                    buttons += '<button class="btn btn-state-active" title="Activate" ' +
                                        'onclick="activateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                        '<i class="fas fa-check"></i></button>';
                                }

                                // Delete dropdown button
                                buttons += '<div class="btn-group btn-group-sm" role="group">' +
                                    '<button type="button" class="btn btn-action-delete dropdown-toggle" ' +
                                    'data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Delete Options">' +
                                    '<i class="fas fa-trash"></i></button>' +
                                    '<div class="dropdown-menu dropdown-menu-right">' +
                                    '<a class="dropdown-item text-warning" href="#" ' +
                                    'onclick="event.preventDefault(); softDeleteUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="fas fa-trash-alt mr-2"></i>Soft Delete (Restorable)</a>' +
                                    '<div class="dropdown-divider"></div>' +
                                    '<a class="dropdown-item text-danger" href="#" ' +
                                    'onclick="event.preventDefault(); hardDeleteUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="fas fa-trash mr-2"></i>Hard Delete (Permanent)</a>' +
                                    '</div></div>';
                            } else {
                                // Restore button
                                buttons += '<button class="btn btn-state-restore" title="Restore" ' +
                                    'onclick="restoreUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                    '<i class="fas fa-undo"></i></button>';
                            }

                            buttons += '</div>';
                            return buttons;
                        }
                    }
                ],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                order: [[8, 'desc']], // Sort by created date descending
                autoWidth: false,
                responsive: true,
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search users...",
                    lengthMenu: "Show _MENU_ users",
                    info: "Showing _START_ to _END_ of _TOTAL_ users",
                    infoEmpty: "No users to display",
                    infoFiltered: "(filtered from _MAX_ total)",
                    zeroRecords: "No matching users found",
                    emptyTable: '<div class="p-4 text-center">' +
                        '<i class="fas fa-users fa-4x text-muted mb-3"></i>' +
                        '<h4 class="text-muted">No Users Found</h4>' +
                        '<p class="text-muted">Get started by creating your first user.</p>' +
                        '<a href="@Url.Action("CreateUserForCenter", "SuperAdmin")" class="btn btn-success">' +
                        '<i class="fas fa-plus"></i> Create Your First User</a></div>'
                },
                columnDefs: [
                    { responsivePriority: 1, targets: 0 },  // # - always visible
                    { responsivePriority: 2, targets: 1 },  // Name - always visible
                    { responsivePriority: 3, targets: 2 },  // Username - always visible
                    { responsivePriority: 4, targets: 10 }, // Actions - always visible
                    { responsivePriority: 5, targets: 6 },  // Role
                    { responsivePriority: 6, targets: 7 },  // Status
                    { responsivePriority: 7, targets: 8 },  // State
                    { responsivePriority: 8, targets: 5 },  // Center
                    { responsivePriority: 9, targets: 3 },  // Email
                    { responsivePriority: 10, targets: 4 }, // Phone
                    { responsivePriority: 11, targets: 9 }  // Created
                ],
                createdRow: function (row, data, dataIndex) {
                    if (data.isDeleted) {
                        $(row).addClass('table-danger');
                    }
                }
            });

            // Filter: Show All
            $('#showAll').click(function () {
                currentFilter = 'all';
                $('#filterInfo').text('Showing all users');
                table.ajax.reload(null, false);
            });

            // Filter: Active Only
            $('#hideDeleted').click(function () {
                currentFilter = 'active';
                $('#filterInfo').text('Showing active users only');
                table.ajax.reload(null, false);
            });

            // Filter: Show Only Deleted
            $('#showDeleted').click(function () {
                currentFilter = 'deleted';
                $('#filterInfo').text('Showing only deleted users');
                table.ajax.reload(null, false);
            });

            // Role Filter
            $('#roleFilter').change(function () {
                currentRole = $(this).val();
                table.ajax.reload(null, false);
            });
        });

        // Restore user function
        function restoreUser(userId, userName) {
            Swal.fire({
                title: 'Restore User?',
                html: 'Are you sure you want to restore<br><strong>' + userName + '</strong>?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-undo"></i> Yes, Restore',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("RestoreUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Restored!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        // Activate user function
        function activateUser(userId, userName) {
            Swal.fire({
                title: 'Activate User?',
                html: 'Activate user<br><strong>' + userName + '</strong>?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-check"></i> Yes, Activate',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("ActivateUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Activated!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        // Deactivate user function
        function deactivateUser(userId, userName) {
            Swal.fire({
                title: 'Deactivate User?',
                html: 'Deactivate user<br><strong>' + userName + '</strong>?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-ban"></i> Yes, Deactivate',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("DeactivateUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deactivated!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        // Soft delete user function
        function softDeleteUser(userId, userName) {
            Swal.fire({
                title: 'Soft Delete User?',
                html: 'Move<br><strong>' + userName + '</strong><br>to trash?<br><small class="text-muted">You can restore it later.</small>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-trash-alt"></i> Yes, Soft Delete',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("SoftDeleteUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Deleted!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }

        // Hard delete user function
        function hardDeleteUser(userId, userName) {
            Swal.fire({
                title: 'Permanently Delete User?',
                html: '<strong class="text-danger">⚠️ WARNING</strong><br>' +
                      'This will <strong>PERMANENTLY DELETE</strong><br>' +
                      '<strong>' + userName + '</strong><br><br>' +
                      '<span class="text-danger">This action CANNOT be undone!</span><br>' +
                      '<small class="text-muted">All user data will be lost forever.</small>',
                icon: 'error',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-trash"></i> Yes, DELETE PERMANENTLY',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("HardDeleteUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Permanently Deleted!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#usersTable').DataTable().ajax.reload(null, false);
                }
            });
        }
    </script>
}

