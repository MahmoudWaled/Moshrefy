@{
    ViewData["Title"] = "Centers Management";
}

<!-- Page header -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <!-- Page pre-title -->
        <div class="page-pretitle">
          Management
        </div>
        <h2 class="page-title">
          Centers
        </h2>
      </div>
      <!-- Page title actions -->
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a asp-action="CreateCenter" class="btn btn-action-create d-none d-sm-inline-block">
            <i class="ti ti-plus icon"></i>
            Create New Center
          </a>
          <a asp-action="Create" class="btn btn-action-create d-sm-none btn-icon">
            <i class="ti ti-plus icon"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

@Html.AntiForgeryToken()

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title" id="cardTitle">All Centers</h3>
            <div class="ms-auto">
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm" id="filterAll">
                  All
                </button>
                <button type="button" class="btn btn-sm" id="filterActive">
                  Active
                </button>
                <button type="button" class="btn btn-sm" id="filterInactive">
                  Inactive
                </button>
                <button type="button" class="btn btn-sm btn-action-delete" id="filterDeleted">
                  <i class="ti ti-trash icon"></i> Deleted
                </button>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-vcenter table-hover" id="centersTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>Created Date</th>
                    <th class="w-1">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Data loaded via AJAX -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
 
  <script>
    var token = $('input[name="__RequestVerificationToken"]').val();

    $(document).ready(function() {
      var table = $('#centersTable').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
          "url": "@Url.Action("GetCentersData", "SuperAdmin")",
          "type": "POST",
          "data": function(d) {
            d.activeFilter = $('#centersTable').data('activeFilter') || 'all';
            d.filterDeleted = $('#centersTable').data('filterDeleted') || 'active';
          },
          "error": function(xhr, error, code) {
            console.error('DataTables error:', error, code);
            Swal.fire({
              icon: 'error',
              title: 'Error Loading Data',
              text: 'Please refresh the page and try again.',
              timer: 3000
            });
          }
        },
        "columns": [
          { 
            "data": "name",
            "name": "Name",
            "render": function(data, type, row) {
              return '<div class="d-flex py-1 align-items-center">' +
                     '<div class="flex-fill">' +
                     '<div class="font-weight-medium">' + data + '</div>' +
                     '</div>' +
                     '</div>';
            }
          },
          { 
            "data": "address",
            "name": "Address"
          },
          { 
            "data": "isActive",
            "name": "IsActive",
            "render": function(data, type, row) {
              if (row.isDeleted) {
                return '<span class="badge bg-danger text-white">Deleted</span>';
              }
              if (data) {
                return '<span class="badge bg-state-active">Active</span>';
              } else {
                return '<span class="badge bg-state-inactive">Inactive</span>';
              }
            }
          },
          { 
            "data": "createdAt",
            "name": "CreatedAt",
            "render": function(data, type, row) {
              if (data) {
                var date = new Date(data);
                return date.toLocaleDateString();
              }
              return '';
            }
          },
          {
            "data": null,
            "orderable": false,
            "render": function(data, type, row) {
              var actions = '<div class="btn-group" role="group">';
              
              if (row.isDeleted) {
                // Restore button for deleted centers
                actions += '<a href="javascript:void(0)" onclick="restoreCenter(' + row.id + ')" class="btn btn-sm btn-action-activate" title="Restore">' +
                          '<i class="ti ti-restore icon"></i>' +
                          '</a>';
                // Permanent delete button
                actions += '<a href="javascript:void(0)" onclick="permanentDeleteCenter(' + row.id + ')" class="btn btn-sm btn-action-delete" title="Permanent Delete">' +
                          '<i class="ti ti-trash-x icon"></i>' +
                          '</a>';
              } else {
                // View button
                actions += '<a href="@Url.Action("CenterDetails", "SuperAdmin")?centerId=' + row.id + '" class="btn btn-sm btn-action-view" title="View">' +
                          '<i class="ti ti-eye icon"></i>' +
                          '</a>';
                
                // Edit button
                actions += '<a href="@Url.Action("EditCenter", "SuperAdmin")?id=' + row.id + '" class="btn btn-sm btn-action-edit" title="Edit">' +
                          '<i class="ti ti-edit icon"></i>' +
                          '</a>';
                
                // Delete button
                actions += '<a href="javascript:void(0)" onclick="deleteCenter(' + row.id + ')" class="btn btn-sm btn-action-delete" title="Delete">' +
                          '<i class="ti ti-trash icon"></i>' +
                          '</a>';
              }
              
              actions += '</div>';
              return actions;
            }
          }
        ],
        "order": [[3, "desc"]],
        "pageLength": 10,
        "language": {
          "search": "Search:",
          "lengthMenu": "Show _MENU_ entries",
          "info": "Showing _START_ to _END_ of _TOTAL_ centers",
          "infoEmpty": "No centers found",
          "infoFiltered": "(filtered from _MAX_ total centers)",
          "paginate": {
            "first": "First",
            "last": "Last",
            "next": "Next",
            "previous": "Previous"
          }
        }
      });

      // Filter buttons - Active/Inactive status filter
      $('#filterAll').click(function() {
        $('#centersTable').data('activeFilter', 'all');
        $('#centersTable').data('filterDeleted', 'active'); // Show non-deleted
        table.ajax.reload();
        $('.btn-group .btn').removeClass('active');
        $(this).addClass('active');
        $('#cardTitle').text('All Centers');
      });

      $('#filterActive').click(function() {
        $('#centersTable').data('activeFilter', 'active');
        $('#centersTable').data('filterDeleted', 'active');
        table.ajax.reload();
        $('.btn-group .btn').removeClass('active');
        $(this).addClass('active');
        $('#cardTitle').text('Active Centers');
      });

      $('#filterInactive').click(function() {
        $('#centersTable').data('activeFilter', 'inactive');
        $('#centersTable').data('filterDeleted', 'active');
        table.ajax.reload();
        $('.btn-group .btn').removeClass('active');
        $(this).addClass('active');
        $('#cardTitle').text('Inactive Centers');
      });

      // Deleted centers filter
      $('#filterDeleted').click(function() {
        $('#centersTable').data('activeFilter', 'all');
        $('#centersTable').data('filterDeleted', 'deleted');
        table.ajax.reload();
        $('.btn-group .btn').removeClass('active');
        $(this).addClass('active');
        $('#cardTitle').text('Deleted Centers');
      });

      // Set default filter
      $('#centersTable').data('activeFilter', 'all');
      $('#centersTable').data('filterDeleted', 'active');
      $('#filterAll').addClass('active');
    });

    function deleteCenter(id) {
      Swal.fire({
        title: 'Move to Trash?',
        html: 'This center will be moved to trash.<br>You can restore it later from the Deleted tab.<br><br>Type <strong>Delete</strong> to confirm:',
        icon: 'warning',
        input: 'text',
        inputPlaceholder: 'Type Delete here',
        showCancelButton: true,
        confirmButtonColor: '#ffc107',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="ti ti-trash"></i> Move to Trash',
        cancelButtonText: 'Cancel',
        inputValidator: function(value) {
          if (value !== 'Delete') {
            return 'Please type "Delete" to confirm';
          }
        }
      }).then(function(result) {
        if (result.isConfirmed) {
          $.ajax({
            url: '@Url.Action("SoftDeleteCenter", "SuperAdmin")',
            type: 'POST',
            data: { id: id, __RequestVerificationToken: token },
            success: function(result) {
              if (result.success) {
                $('#centersTable').DataTable().ajax.reload();
                Swal.fire({
                  icon: 'success',
                  title: 'Moved to Trash!',
                  text: result.message || 'Center moved to trash successfully. You can restore it from the Deleted tab.',
                  timer: 2500,
                  showConfirmButton: false
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Error: ' + result.message
                });
              }
            },
            error: function() {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error moving center to trash'
              });
            }
          });
        }
      });
    }

    function restoreCenter(id) {
      Swal.fire({
        title: 'Restore Center?',
        text: 'Are you sure you want to restore this center?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="ti ti-restore"></i> Yes, Restore',
        cancelButtonText: 'Cancel'
      }).then(function(result) {
        if (result.isConfirmed) {
          $.ajax({
            url: '@Url.Action("RestoreCenter", "SuperAdmin")',
            type: 'POST',
            data: { id: id, __RequestVerificationToken: token },
            success: function(result) {
              if (result.success) {
                $('#centersTable').DataTable().ajax.reload();
                Swal.fire({
                  icon: 'success',
                  title: 'Restored!',
                  text: result.message || 'Center restored successfully',
                  timer: 2000,
                  showConfirmButton: false
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Error restoring center: ' + result.message
                });
              }
            },
            error: function() {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error restoring center'
              });
            }
          });
        }
      });
    }

    function permanentDeleteCenter(id) {
      Swal.fire({
        title: 'PERMANENT DELETE',
        html: '<div class="alert alert-danger mb-2"><strong>DANGER!</strong> This cannot be undone!</div>Type <code>DELETE</code> to confirm:',
        input: 'text',
        inputPlaceholder: 'Type Delete',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="ti ti-trash-x"></i> PERMANENTLY DELETE',
        cancelButtonText: 'Cancel',
        preConfirm: function(value) {
          if (value !== 'Delete') {
            Swal.showValidationMessage('You must type Delete to confirm');
          }
        }
      }).then(function(result) {
        if (result.isConfirmed) {
          $.ajax({
            url: '@Url.Action("HardDeleteCenter", "SuperAdmin")',
            type: 'POST',
            data: { id: id, __RequestVerificationToken: token },
            success: function(result) {
              if (result.success) {
                $('#centersTable').DataTable().ajax.reload();
                Swal.fire({
                  icon: 'success',
                  title: 'Deleted!',
                  text: result.message || 'Center permanently deleted',
                  timer: 2000,
                  showConfirmButton: false
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Error deleting center: ' + result.message
                });
              }
            },
            error: function() {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error deleting center'
              });
            }
          });
        }
      });
    }
  </script>
}
