@model Moshrefy.Web.Models.User.UpdateUserRoleVM
@{
    ViewData["Title"] = "Update User Role";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page header -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">Users</div>
        <h2 class="page-title"><i class="ti ti-tag"></i> Update User Role</h2>
      </div>
    </div>
  </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row">
      <!-- User Info Card -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="ti ti-user me-2"></i>User Information</h3>
          </div>
          <div class="card-body text-center">
            <span class="avatar avatar-xl bg-primary-lt mb-3"><i class="ti ti-user icon-lg"></i></span>
            <h3 class="mb-3">@ViewBag.UserName</h3>
            <div class="mb-3">
              <strong>Current Role: </strong>
              @if (!string.IsNullOrEmpty(ViewBag.CurrentRole))
              {
                var bgClass = (string)ViewBag.CurrentRole switch { "SuperAdmin" => "bg-role-superadmin", "Admin" => "bg-role-admin", "Manager" => "bg-role-manager", _ => "bg-role-employee" };
                var icon = (string)ViewBag.CurrentRole switch { "SuperAdmin" => "ti-shield", "Admin" => "ti-tie", "Manager" => "ti-settings", _ => "ti-user" };
                <span class="badge @bgClass"><i class="ti @icon me-1"></i>@ViewBag.CurrentRole</span>
              }
              else
              {<span class="text-muted">Not assigned</span>}
            </div>
            <a asp-action="UserDetails" asp-route-id="@ViewBag.UserId" class="btn btn-outline-primary w-100"><i class="ti ti-eye"></i> View Full Profile</a>
          </div>
        </div>

        <div class="card mt-3">
          <div class="card-header">
            <h3 class="card-title"><i class="ti ti-alert-triangle me-2"></i>Important</h3>
          </div>
          <div class="card-body">
            <ul class="list-unstyled text-muted">
              <li class="mb-2"><i class="ti ti-info-circle me-1"></i>Role changes apply immediately</li>
              <li class="mb-2"><i class="ti ti-refresh me-1"></i>User may need to re-login</li>
              <li><i class="ti ti-shield me-1"></i>Assign appropriate roles only</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Update Role Form -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="ti ti-settings me-2"></i>Change User Role</h3>
          </div>
          <form asp-action="UpdateUserRole" asp-route-id="@ViewBag.UserId" method="post" id="updateRoleForm">
            @Html.AntiForgeryToken()
            <div class="card-body">
              <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

              <div class="mb-3">
                <label class="form-label"><i class="ti ti-tag me-1"></i>Select New Role</label>
                <div class="form-selectgroup form-selectgroup-boxes d-flex flex-column">
                  <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="Role" value="@((int)Moshrefy.Domain.Enums.RolesNames.SuperAdmin)" class="form-selectgroup-input" @(Model.Role == Moshrefy.Domain.Enums.RolesNames.SuperAdmin ? "checked" : "")>
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                      <div class="me-3"><span class="form-selectgroup-check"></span></div>
                      <div><span class="badge bg-role-superadmin"><i class="ti ti-shield me-1"></i>Super Admin</span><div class="text-muted mt-1">Full system access and control over all centers</div></div>
                    </div>
                  </label>
                  <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="Role" value="@((int)Moshrefy.Domain.Enums.RolesNames.Admin)" class="form-selectgroup-input" @(Model.Role == Moshrefy.Domain.Enums.RolesNames.Admin ? "checked" : "")>
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                      <div class="me-3"><span class="form-selectgroup-check"></span></div>
                      <div><span class="badge bg-role-admin"><i class="ti ti-tie me-1"></i>Admin</span><div class="text-muted mt-1">Full access to manage their assigned center</div></div>
                    </div>
                  </label>
                  <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="Role" value="@((int)Moshrefy.Domain.Enums.RolesNames.Manager)" class="form-selectgroup-input" @(Model.Role == Moshrefy.Domain.Enums.RolesNames.Manager ? "checked" : "")>
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                      <div class="me-3"><span class="form-selectgroup-check"></span></div>
                      <div><span class="badge bg-role-manager"><i class="ti ti-settings me-1"></i>Manager</span><div class="text-muted mt-1">Can manage operations and view reports</div></div>
                    </div>
                  </label>
                  <label class="form-selectgroup-item flex-fill">
                    <input type="radio" name="Role" value="@((int)Moshrefy.Domain.Enums.RolesNames.Employee)" class="form-selectgroup-input" @(Model.Role == Moshrefy.Domain.Enums.RolesNames.Employee ? "checked" : "")>
                    <div class="form-selectgroup-label d-flex align-items-center p-3">
                      <div class="me-3"><span class="form-selectgroup-check"></span></div>
                      <div><span class="badge bg-role-employee"><i class="ti ti-user me-1"></i>Employee</span><div class="text-muted mt-1">Basic access for daily operations</div></div>
                    </div>
                  </label>
                </div>
                <span asp-validation-for="Role" class="text-danger"></span>
              </div>
            </div>
            <div class="card-footer text-end">
              <a asp-action="UserDetails" asp-route-id="@ViewBag.UserId" class="btn btn-secondary me-2"><i class="ti ti-x"></i> Cancel</a>
              <button type="submit" class="btn btn-purple"><i class="ti ti-device-floppy"></i> Update Role</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $('#updateRoleForm').on('submit', function (e) {
            e.preventDefault();
            const selectedRole = $('input[name="Role"]:checked').closest('label').find('.badge').text().trim();
            Swal.fire({ title: 'Confirm Role Update', html: 'Update <strong>@ViewBag.UserName</strong> role to:<br><br><span class="badge bg-purple">' + selectedRole + '</span>', icon: 'question', showCancelButton: true, confirmButtonColor: '#28a745', confirmButtonText: '<i class="ti ti-check"></i> Yes, Update' })
            .then((r) => { if (r.isConfirmed) { this.submit(); } });
        });
    </script>
    <style>.bg-purple,.btn-purple{background-color:#6f42c1!important;color:white;}.btn-purple:hover{background-color:#5a32a3!important;}</style>
}
