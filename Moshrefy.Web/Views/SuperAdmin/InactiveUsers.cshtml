@{
    ViewData["Title"] = "Inactive Users";
}

<!-- Content Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>
                    <i class="fas fa-user-times"></i> Inactive Users
                </h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-action="Users">Users</a></li>
                    <li class="breadcrumb-item active">Inactive</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card card-warning">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-ban"></i> Inactive Users List
                        </h3>
                        <div class="card-tools">
                            <a asp-action="Users" class="btn btn-sm btn-light">
                                <i class="fas fa-arrow-left"></i> Back to All Users
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Alert messages -->
                        @if (TempData["SuccessMessage"] != null)
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle"></i>
                                @TempData["SuccessMessage"]
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        }
                        @if (TempData["ErrorMessage"] != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-circle"></i>
                                @TempData["ErrorMessage"]
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        }

                        <!-- Info Alert -->
                        <div class="alert alert-info">
                            <h5><i class="icon fas fa-info"></i> About Inactive Users</h5>
                            Inactive users are accounts that have been deactivated but not deleted. They cannot log in but can be reactivated at any time.
                        </div>

                        <div class="table-responsive">
                            <table id="inactiveUsersTable" class="table table-bordered table-hover table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>#</th>
                                        <th data-name="Name">Name</th>
                                        <th data-name="UserName">Username</th>
                                        <th data-name="Email">Email</th>
                                        <th data-name="PhoneNumber">Phone</th>
                                        <th data-name="CenterName">Center</th>
                                        <th data-name="RoleName">Role</th>
                                        <th data-name="CreatedAt">Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data loaded via AJAX -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">

    <!-- Custom CSS -->

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function () {
            var isFirstLoad = true;

            // Initialize DataTable
            var table = $('#inactiveUsersTable').DataTable({
                processing: false,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetInactiveUsersData", "SuperAdmin")',
                    type: 'POST',
                    error: function (xhr, error, code) {
                        console.error('DataTables error:', error, code);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error Loading Data',
                            text: 'Please refresh the page and try again.',
                            timer: 3000
                        });
                    },
                    beforeSend: function () {
                        if (isFirstLoad) {
                            $('#inactiveUsersTable tbody').html(
                                '<tr><td colspan="9" class="text-center py-5">' +
                                '<div class="spinner-border text-warning" role="status">' +
                                '<span class="sr-only">Loading...</span></div>' +
                                '<br><span class="text-muted mt-2">Loading inactive users...</span>' +
                                '</td></tr>'
                            );
                        }
                    },
                    complete: function () {
                        isFirstLoad = false;
                    }
                },
                columns: [
                    {
                        data: null,
                        orderable: false,
                        searchable: false,
                        width: '40px',
                        className: 'text-center align-middle',
                        render: function (data, type, row, meta) {
                            return '<span class="text-muted">' + (meta.row + meta.settings._iDisplayStart + 1) + '</span>';
                        }
                    },
                    {
                        data: 'name',
                        name: 'Name',
                        width: '150px',
                        className: 'align-middle',
                        render: function (data) {
                            return '<i class="fas fa-user text-warning mr-1"></i> <strong>' + data + '</strong>';
                        }
                    },
                    {
                        data: 'userName',
                        name: 'UserName',
                        width: '120px',
                        className: 'align-middle',
                        render: function (data) {
                            return '<code>' + data + '</code>';
                        }
                    },
                    {
                        data: 'email',
                        name: 'Email',
                        width: '180px',
                        className: 'align-middle',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<a href="mailto:' + data + '" class="text-info">' + data + '</a>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'phoneNumber',
                        name: 'PhoneNumber',
                        width: '120px',
                        className: 'align-middle text-nowrap',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<i class="fas fa-phone text-success mr-1"></i> ' + data;
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'centerName',
                        name: 'CenterName',
                        width: '150px',
                        className: 'align-middle',
                        render: function (data) {
                            if (data && data !== '') {
                                return '<i class="fas fa-building text-info mr-1"></i> <small>' + data + '</small>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'roleName',
                        name: 'RoleName',
                        width: '100px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            if (data) {
                                var badgeClass = 'badge-secondary';
                                var icon = 'fa-user';
                                
                                switch(data) {
                                    case 'SuperAdmin':
                                        badgeClass = 'badge-danger';
                                        icon = 'fa-user-shield';
                                        break;
                                    case 'Admin':
                                        badgeClass = 'badge-warning';
                                        icon = 'fa-user-tie';
                                        break;
                                    case 'Manager':
                                        badgeClass = 'badge-primary';
                                        icon = 'fa-user-cog';
                                        break;
                                    case 'Employee':
                                        badgeClass = 'badge-info';
                                        icon = 'fa-user';
                                        break;
                                }
                                
                                return '<span class="badge ' + badgeClass + ' px-2">' +
                                       '<i class="fas ' + icon + '"></i> ' + data + '</span>';
                            }
                            return '<span class="text-muted">N/A</span>';
                        }
                    },
                    {
                        data: 'createdAt',
                        name: 'CreatedAt',
                        width: '110px',
                        className: 'text-center align-middle',
                        render: function (data) {
                            var date = new Date(data);
                            var formatted = date.toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric'
                            });
                            return '<small class="text-muted"><i class="fas fa-clock mr-1"></i>' + formatted + '</small>';
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        width: '150px',
                        className: 'text-center align-middle',
                        render: function (data, type, row) {
                            var buttons = '<div class="btn-group btn-group-sm" role="group">';

                            // View button
                            buttons += '<a href="@Url.Action("UserDetails", "SuperAdmin")/' + row.id + '" ' +
                                'class="btn btn-info" title="View Details">' +
                                '<i class="fas fa-eye"></i></a>';

                            // Activate button (since all users in this view are inactive)
                            buttons += '<button class="btn btn-success" title="Activate" ' +
                                'onclick="activateUser(\'' + row.id + '\', \'' + row.userName.replace(/'/g, "\\'") + '\')">' +
                                '<i class="fas fa-check"></i></button>';

                            buttons += '</div>';
                            return buttons;
                        }
                    }
                ],
                pageLength: 25,
                lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
                order: [[7, 'desc']], // Sort by created date descending
                autoWidth: false,
                responsive: true,
                language: {
                    search: "_INPUT_",
                    searchPlaceholder: "Search inactive users...",
                    lengthMenu: "Show _MENU_ users",
                    info: "Showing _START_ to _END_ of _TOTAL_ inactive users",
                    infoEmpty: "No inactive users to display",
                    infoFiltered: "(filtered from _MAX_ total)",
                    zeroRecords: "No matching inactive users found",
                    emptyTable: '<div class="p-4 text-center">' +
                        '<i class="fas fa-user-check fa-4x text-success mb-3"></i>' +
                        '<h4 class="text-success">Great! No Inactive Users</h4>' +
                        '<p class="text-muted">All users are currently active.</p>' +
                        '<a href="@Url.Action("Users", "SuperAdmin")" class="btn btn-primary">' +
                        '<i class="fas fa-users"></i> View All Users</a></div>'
                }
            });
        });

        // Activate user function
        function activateUser(userId, userName) {
            Swal.fire({
                title: 'Activate User?',
                html: 'Activate user<br><strong>' + userName + '</strong>?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="fas fa-check"></i> Yes, Activate',
                cancelButtonText: 'Cancel',
                showLoaderOnConfirm: true,
                preConfirm: function () {
                    return $.post('@Url.Action("ActivateUser", "SuperAdmin")', { id: userId })
                        .then(function (response) {
                            if (!response.success) {
                                throw new Error(response.message);
                            }
                            return response;
                        })
                        .catch(function (error) {
                            Swal.showValidationMessage('Request failed: ' + error.message);
                        });
                },
                allowOutsideClick: function () { return !Swal.isLoading(); }
            }).then(function (result) {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Activated!',
                        text: result.value.message,
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#inactiveUsersTable').DataTable().ajax.reload(null, false);
                }
            });
        }
    </script>
}
