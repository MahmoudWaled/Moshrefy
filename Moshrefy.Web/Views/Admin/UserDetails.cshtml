@model Moshrefy.Web.Models.User.UserVM
@{
    ViewData["Title"] = "Team Member Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page Header -->
<div class="page-header-modern">
    <div class="row g-2 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb-modern">
                    <li class="breadcrumb-item">
                        <a asp-controller="Admin" asp-action="Index"><i class="ti ti-home"></i> My Center</a>
                        <i class="ti ti-chevron-right breadcrumb-separator ms-2"></i>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="Admin" asp-action="Users">My Team</a>
                        <i class="ti ti-chevron-right breadcrumb-separator ms-2"></i>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
                </ol>
            </nav>
            <h2 class="page-title"><i class="ti ti-user"></i> Team Member Details</h2>
        </div>
        <div class="col-auto ms-auto">
            <button type="button" onclick="goBack()" class="btn">
                <i class="ti ti-arrow-left"></i> Back
            </button>
        </div>
    </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row">
      <!-- Member Info Card -->
      <div class="col-md-4">
        <div class="card">
          <div class="card-body text-center">
            <div class="avatar avatar-xl mb-3" style="background-color: var(--tblr-primary); color: white; font-size: 2rem;">
              @Model.Name.Substring(0, 1).ToUpper()
            </div>
            <h3 class="card-title mb-1">@Model.Name</h3>
            <p class="text-muted">@@@Model.UserName</p>

            <div class="mb-3">
              @if (Model.IsActive)
              {
                <span class="badge bg-state-active">Active Member</span>
              }
              else
              {
                <span class="badge bg-secondary">Inactive</span>
              }
              <br />
              @if (!string.IsNullOrEmpty(Model.RoleName))
              {
                <span class="badge mt-2 @(Model.RoleName == "Employee" ? "bg-role-employee" : Model.RoleName == "Manager" ? "bg-role-manager" : "bg-secondary")">
                  <i class="ti @(Model.RoleName == "Employee" ? "ti-user" : "ti-user-cog")"></i>
                  @Model.RoleName
                </span>
              }
            </div>

            <div class="list-group list-group-flush text-start">
              @if (!string.IsNullOrEmpty(Model.Email))
              {
                <div class="list-group-item">
                  <i class="ti ti-mail me-2 text-muted"></i><strong>Email:</strong> @Model.Email
                </div>
              }
              @if (!string.IsNullOrEmpty(Model.PhoneNumber))
              {
                <div class="list-group-item">
                  <i class="ti ti-phone me-2 text-muted"></i><strong>Phone:</strong> @Model.PhoneNumber
                </div>
              }
            </div>

            <div class="mt-3">
              <a asp-action="EditUser" asp-route-id="@Model.Id" class="btn btn-action-edit w-100">
                <i class="ti ti-edit"></i> Edit Info
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions Card -->
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Member Actions</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <div class="card bg-light">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                      <span class="avatar bg-purple text-white me-3"><i class="ti ti-tag"></i></span>
                      <div>
                        <strong>Member Type</strong>
                        <div class="text-muted small">Current: <strong>@Model.RoleName</strong></div>
                      </div>
                    </div>
                    <button class="btn btn-sm btn-purple" type="button" data-bs-toggle="modal" data-bs-target="#changeRoleModal">
                      <i class="ti ti-arrows-exchange"></i> Change Type
                    </button>
                  </div>
                </div>
              </div>

              <div class="col-md-6 mb-3">
                <div class="card bg-light">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                      <span class="avatar bg-action-view text-white me-3"><i class="ti ti-key"></i></span>
                      <div>
                        <strong>Access Control</strong>
                        <div class="text-muted small">@(Model.IsActive ? "Currently has access" : "Access disabled")</div>
                      </div>
                    </div>
                    @if (Model.IsActive)
                    {
                      <button class="btn btn-sm btn-state-deactive" onclick="deactivateMember()">
                        <i class="ti ti-ban"></i> Disable Access
                      </button>
                    }
                    else
                    {
                      <button class="btn btn-sm btn-state-active" onclick="activateMember()">
                        <i class="ti ti-check"></i> Enable Access
                      </button>
                    }
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12 mb-3">
                <div class="card bg-light">
                  <div class="card-body">
                    <div class="d-flex align-items-center mb-2">
                      <span class="avatar bg-action-delete text-white me-3"><i class="ti ti-user-off"></i></span>
                      <div>
                        <strong>Remove Member</strong>
                        <div class="text-muted small">This can be undone later</div>
                      </div>
                    </div>
                    <button class="btn btn-sm btn-action-delete" onclick="removeMember()">
                      <i class="ti ti-trash"></i> Remove from Team
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Member Activity -->
            <div class="card">
              <div class="card-header">
                <h4 class="card-title"><i class="ti ti-clock me-2"></i>Member Since</h4>
              </div>
              <div class="card-body">
                <p><strong>Joined:</strong> @Model.CreatedAt.ToString("MMMM dd, yyyy")</p>
                @if (!string.IsNullOrEmpty(Model.CreatedByName))
                {
                  <p><strong>Added by:</strong> @Model.CreatedByName</p>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Change Role Modal -->
<div class="modal fade" id="changeRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Member Type</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Select the new type for <strong>@Model.Name</strong>:</p>
        <div class="mb-3">
          <label class="form-label">Member Type</label>
          <select id="newRoleSelect" class="form-select">
            <option value="">-- Select Type --</option>
            <option value="Employee">Employee</option>
            <option value="Manager">Manager</option>
          </select>
        </div>
        <div class="alert alert-info" id="roleDescriptionModal" style="display: none;">
          <i class="ti ti-info-circle me-2"></i><span id="roleDescriptionTextModal"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-action-edit" onclick="changeRole()">Change Type</button>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '@Url.Action("Users", "Admin")';
            }
        }
        
        const roleDescriptions = {
            'Employee': 'Regular team member who can handle day-to-day tasks.',
            'Manager': 'Senior team member with additional permissions.'
        };

        // Initialize modal when document is ready
        var changeRoleModal;
        $(document).ready(function() {
            var changeRoleModalEl = document.getElementById('changeRoleModal');
            if (changeRoleModalEl) {
                changeRoleModal = new bootstrap.Modal(changeRoleModalEl);
            }
        });

        function showChangeRoleModal() { 
            if (changeRoleModal) {
                changeRoleModal.show(); 
            } else {
                TablerDialog.fire('Error', 'Could not open modal. Please refresh the page.', 'error');
            }
        }

        $('#newRoleSelect').change(function() {
            var r = $(this).val();
            if (r && roleDescriptions[r]) { 
                $('#roleDescriptionTextModal').text(roleDescriptions[r]); 
                $('#roleDescriptionModal').slideDown(); 
            }
            else { 
                $('#roleDescriptionModal').slideUp(); 
            }
        });

        function changeRole() {
            var newRole = $('#newRoleSelect').val();
            if (!newRole) { 
                TablerDialog.fire('Error', 'Please select a member type', 'error'); 
                return; 
            }
            TablerDialog.fire({ 
                title: 'Change Type?', 
                text: 'Change to ' + newRole + '?', 
                icon: 'question', 
                showCancelButton: true, 
                confirmButtonColor: '#6f42c1', 
                confirmButtonText: 'Yes, change' 
            })
            .then((r) => { 
                if (r.isConfirmed) { 
                    $.post('@Url.Action("ChangeUserRole")', { id: '@Model.Id', newRole: newRole })
                    .done((res) => { 
                        if (res.success) { 
                            if (changeRoleModal) changeRoleModal.hide(); 
                            TablerDialog.fire({ 
                                icon: 'success', 
                                title: 'Success!', 
                                text: res.message,
                                timer: 2000, 
                                showConfirmButton: false 
                            }).then(() => location.reload()); 
                        } else { 
                            TablerDialog.fire('Error', res.message, 'error'); 
                        } 
                    })
                    .fail(function() {
                        TablerDialog.fire('Error', 'An error occurred while changing type.', 'error');
                    }); 
                } 
            });
        }

        function activateMember() {
            TablerDialog.fire({ title: 'Enable Access?', icon: 'question', showCancelButton: true, confirmButtonColor: '#28a745', confirmButtonText: '<i class="ti ti-check"></i> Yes, enable' })
            .then((r) => { if (r.isConfirmed) { $.post('@Url.Action("ActivateUser")', { id: '@Model.Id' }).done((res) => { if (res.success) { TablerDialog.fire({ icon: 'success', title: 'Enabled!', timer: 2000, showConfirmButton: false }).then(() => location.reload()); } }); } });
        }

        function deactivateMember() {
            TablerDialog.fire({ title: 'Disable Access?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ffc107', confirmButtonText: '<i class="ti ti-ban"></i> Yes, disable' })
            .then((r) => { if (r.isConfirmed) { $.post('@Url.Action("DeactivateUser")', { id: '@Model.Id' }).done((res) => { if (res.success) { TablerDialog.fire({ icon: 'success', title: 'Disabled!', timer: 2000, showConfirmButton: false }).then(() => location.reload()); } }); } });
        }

        function removeMember() {
            TablerDialog.fire({
                title: 'Remove Team Member?',
                html: 'This action cannot be undone.<br><br>Type <strong>Delete</strong> to confirm:',
                icon: 'warning',
                input: 'text',
                inputPlaceholder: 'Type Delete here',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ti ti-trash"></i> Remove',
                cancelButtonText: 'Cancel',
                inputValidator: (value) => {
                    if (value !== 'Delete') {
                        return 'Please type "Delete" to confirm';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("SoftDeleteUser")', { id: '@Model.Id' })
                        .done(function(response) {
                            if (response.success) {
                                TablerDialog.fire({
                                    icon: 'success',
                                    title: 'Removed!',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                }).then(() => window.location.href = '@Url.Action("Users")');
                            } else {
                                TablerDialog.fire('Error', response.message, 'error');
                            }
                        })
                        .fail(function() {
                            TablerDialog.fire('Error', 'An error occurred', 'error');
                        });
                }
            });
        }
    </script>
    <style>.bg-purple,.btn-purple{background-color:#6f42c1!important;color:white;}.btn-purple:hover{background-color:#5a32a3!important;}</style>
}
