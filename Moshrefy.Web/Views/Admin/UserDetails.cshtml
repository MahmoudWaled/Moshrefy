@model Moshrefy.Web.Models.User.UserVM
@{
    ViewData["Title"] = "Team Member Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page Header -->
<div class="bg-white p-4 mb-4 shadow-sm border-bottom">
    <div class="container-fluid">
        <div class="row align-items-center">

            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2" style="--bs-breadcrumb-divider: 'â€º';">
                        <li class="breadcrumb-item">
                            <a asp-controller="Admin" asp-action="Index" class="text-decoration-none text-muted small">
                                <i class="bi bi-house-door me-1"></i> My Center
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a asp-controller="Admin" asp-action="Users" class="text-decoration-none text-muted small">
                                My Team
                            </a>
                        </li>
                        <li class="breadcrumb-item active small fw-medium text-primary" aria-current="page">
                            @Model.Name
                        </li>
                    </ol>
                </nav>
                <div class="d-flex align-items-center">
                    <h2 class="h4 fw-bold text-dark mb-0 me-3">
                        <i class="bi bi-person me-2"></i>Team Member Details
                    </h2>
                </div>
            </div>

            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="d-flex gap-2 justify-content-md-end">
                    <a asp-action="Users" class="btn btn-outline-secondary btn-sm px-3 shadow-sm">
                        <i class="bi bi-chevron-left me-1"></i> Back to Team
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- Page body -->
<div class="row">
    <!-- Member Info Card -->
    <div class="col-md-4">
        <div class="card shadow-sm border-0">
            <div class="card-body text-center">
                <div class="d-flex align-items-center justify-content-center bg-primary-subtle text-primary rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                    @Model.Name.Substring(0, 1).ToUpper()
                </div>
                <h4 class="mb-1">@Model.Name</h4>
                <p class="text-muted">@@@Model.UserName</p>

                <div class="mb-3">
                    @if (Model.IsActive)
                    {
                        <span class="badge bg-success">Active Member</span>
                    }
                    else
                    {
                        <span class="badge bg-secondary">Inactive</span>
                    }
                    <br />
                    @if (!string.IsNullOrEmpty(Model.RoleName))
                    {
                        <span class="text-muted mt-2 d-inline-block">@Model.RoleName</span>
                    }
                </div>

                <div class="list-group list-group-flush text-start mb-3">
                    @if (!string.IsNullOrEmpty(Model.Email))
                    {
                        <div class="list-group-item border-0 px-0">
                            <i class="bi bi-envelope me-2 text-muted"></i><strong>Email:</strong> @Model.Email
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                    {
                        <div class="list-group-item border-0 px-0">
                            <i class="bi bi-telephone me-2 text-muted"></i><strong>Phone:</strong> @Model.PhoneNumber
                        </div>
                    }
                </div>

                <a asp-action="EditUser" asp-route-id="@Model.Id" class="btn btn-primary w-100">
                    <i class="bi bi-pencil me-1"></i> Edit Info
                </a>
            </div>
        </div>
    </div>

    <!-- Actions Card -->
    <div class="col-md-8">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h3 class="card-title h5 mb-0 fw-semibold">
                    <i class="bi bi-gear me-2 text-primary"></i>Member Actions
                </h3>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="d-flex align-items-center justify-content-center bg-secondary text-white rounded me-3" style="width: 40px; height: 40px;">
                                        <i class="bi bi-tag"></i>
                                    </span>
                                    <div>
                                        <strong>Member Type</strong>
                                        <div class="text-muted small">Current: <strong>@Model.RoleName</strong></div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="modal" data-bs-target="#changeRoleModal">
                                    <i class="bi bi-arrow-left-right me-1"></i> Change Type
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="d-flex align-items-center justify-content-center bg-info text-white rounded me-3" style="width: 40px; height: 40px;">
                                        <i class="bi bi-key"></i>
                                    </span>
                                    <div>
                                        <strong>Access Control</strong>
                                        <div class="text-muted small">@(Model.IsActive ? "Currently has access" : "Access disabled")</div>
                                    </div>
                                </div>
                                @if (Model.IsActive)
                                {
                                    <button class="btn btn-sm btn-warning" onclick="deactivateMember()">
                                        <i class="bi bi-pause-circle me-1"></i> Disable Access
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-success" onclick="activateMember()">
                                        <i class="bi bi-check-circle me-1"></i> Enable Access
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <div class="card bg-light border-0">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="d-flex align-items-center justify-content-center bg-danger text-white rounded me-3" style="width: 40px; height: 40px;">
                                        <i class="bi bi-person-x"></i>
                                    </span>
                                    <div>
                                        <strong>Remove Member</strong>
                                        <div class="text-muted small">This can be undone later</div>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-danger" onclick="removeMember()">
                                    <i class="bi bi-trash me-1"></i> Remove from Team
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Member Activity -->
                <div class="card mt-3 border-0">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0"><i class="bi bi-clock me-2"></i>Member Since</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>Joined:</strong> @Model.CreatedAt.ToString("MMMM dd, yyyy")</p>
                        @if (!string.IsNullOrEmpty(Model.CreatedByName))
                        {
                            <p class="mb-0"><strong>Added by:</strong> @Model.CreatedByName</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Role Modal -->
<div class="modal fade" id="changeRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Member Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select the new type for <strong>@Model.Name</strong>:</p>
                <div class="mb-3">
                    <label class="form-label">Member Type</label>
                    <select id="newRoleSelect" class="form-select">
                        <option value="">-- Select Type --</option>
                        <option value="Employee">Employee</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
                <div class="alert alert-info" id="roleDescriptionModal" style="display: none;">
                    <i class="bi bi-info-circle me-2"></i><span id="roleDescriptionTextModal"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="changeRole()">Change Type</button>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("_Modals")
@await Html.PartialAsync("_Toast")

@section Scripts {
    <script>
        const token = $('input[name="__RequestVerificationToken"]').val();
        
        const roleDescriptions = {
            'Employee': 'Regular team member who can handle day-to-day tasks.',
            'Manager': 'Senior team member with additional permissions.'
        };

        var changeRoleModal;
        $(document).ready(function() {
            var changeRoleModalEl = document.getElementById('changeRoleModal');
            if (changeRoleModalEl) {
                changeRoleModal = new bootstrap.Modal(changeRoleModalEl);
            }
        });

        $('#newRoleSelect').change(function() {
            var r = $(this).val();
            if (r && roleDescriptions[r]) { 
                $('#roleDescriptionTextModal').text(roleDescriptions[r]); 
                $('#roleDescriptionModal').slideDown(); 
            }
            else { 
                $('#roleDescriptionModal').slideUp(); 
            }
        });

        function changeRole() {
            var newRole = $('#newRoleSelect').val();
            if (!newRole) { 
                showAlert('error', 'Please select a member type'); 
                return; 
            }
            
            setupModal({
                title: 'Change Type?',
                body: 'Change to <strong>' + newRole + '</strong>?',
                btnClass: 'btn-primary',
                btnText: 'Yes, Change',
                showInput: false,
                onConfirm: () => {
                    $.post('@Url.Action("ChangeUserRole")', { id: '@Model.Id', newRole: newRole, __RequestVerificationToken: token })
                        .done((res) => { 
                            if (res.success) { 
                                if (changeRoleModal) changeRoleModal.hide(); 
                                showAlert('success', res.message);
                                setTimeout(() => location.reload(), 1500);
                            } else { 
                                showAlert('error', res.message); 
                            } 
                        })
                        .fail(function() {
                            showAlert('error', 'An error occurred while changing type.');
                        }); 
                }
            });
        }

        function activateMember() {
            setupModal({
                title: 'Enable Access?',
                body: 'Enable access for this team member?',
                btnClass: 'btn-success',
                btnText: 'Yes, Enable',
                showInput: false,
                onConfirm: () => {
                    $.post('@Url.Action("ActivateUser")', { id: '@Model.Id', __RequestVerificationToken: token })
                        .done((res) => { 
                            if (res.success) { 
                                showAlert('success', 'Access enabled!');
                                setTimeout(() => location.reload(), 1500);
                            } 
                        });
                }
            });
        }

        function deactivateMember() {
            setupModal({
                title: 'Disable Access?',
                body: 'This member will not be able to log in.',
                btnClass: 'btn-warning',
                btnText: 'Yes, Disable',
                showInput: false,
                onConfirm: () => {
                    $.post('@Url.Action("DeactivateUser")', { id: '@Model.Id', __RequestVerificationToken: token })
                        .done((res) => { 
                            if (res.success) { 
                                showAlert('success', 'Access disabled!');
                                setTimeout(() => location.reload(), 1500);
                            } 
                        });
                }
            });
        }

        function removeMember() {
            setupModal({
                title: 'Remove Team Member?',
                body: 'This action cannot be undone.<br><br>Type <strong>Delete</strong> to confirm:',
                btnClass: 'btn-danger',
                btnText: 'Remove',
                showInput: true,
                inputPlaceholder: 'Type Delete here',
                onConfirm: (inputVal) => {
                    if (inputVal !== 'Delete') {
                        showAlert('error', 'Please type "Delete" to confirm');
                        return;
                    }
                    $.post('@Url.Action("SoftDeleteUser")', { id: '@Model.Id', __RequestVerificationToken: token })
                        .done(function(response) {
                            if (response.success) {
                                showAlert('success', response.message);
                                setTimeout(() => window.location.href = '@Url.Action("Users")', 1500);
                            } else {
                                showAlert('error', response.message);
                            }
                        })
                        .fail(function() {
                            showAlert('error', 'An error occurred');
                        });
                }
            });
        }
    </script>
}
