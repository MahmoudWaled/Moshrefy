@{
    ViewData["Title"] = "My Team";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Content Header -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1><i class="fas fa-users"></i> My Team</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item active">My Team</li>
                </ol>
            </div>
        </div>
    </div>
</section>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Team Members</h3>
                        <div class="card-tools">
                            <a asp-action="CreateUser" class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> Add New Member
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filter Options -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label>Show:</label>
                                <select id="filterStatus" class="form-control">
                                    <option value="all">All Members</option>
                                    <option value="active">Active Members</option>
                                    <option value="inactive">Inactive Members</option>
                                </select>
                            </div>
                        </div>

                        <!-- DataTable -->
                        <table id="usersTable" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="~/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="~/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    
    <!-- DataTables JS -->
    <script src="~/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="~/plugins/sweetalert2/sweetalert2.min.css">
    <script src="~/plugins/sweetalert2/sweetalert2.min.js"></script>
    
    <script>
        $(document).ready(function () {
            console.log('Initializing Users DataTable...');
            
            var table = $('#usersTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetUsersData")',
                    type: 'POST',
                    data: function (d) {
                        d.filterStatus = $('#filterStatus').val();
                        console.log('Sending request with filter:', d.filterStatus);
                    },
                    error: function (xhr, error, thrown) {
                        console.error('DataTable Error:', error, thrown);
                        console.error('Response:', xhr.responseText);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error Loading Data',
                            text: error + '. Check console for details.'
                        });
                    },
                    dataSrc: function(json) {
                        console.log('Received data:', json);
                        return json.data;
                    }
                },
                columns: [
                    { data: 'name', name: 'name' },
                    { data: 'userName', name: 'userName' },
                    { data: 'email', name: 'email', defaultContent: '' },
                    { data: 'phoneNumber', name: 'phoneNumber', defaultContent: '' },
                    {
                        data: 'roleName',
                        name: 'roleName',
                        render: function (data, type, row) {
                            if (data === 'Employee') {
                                return '<span class="badge badge-primary">Employee</span>';
                            } else if (data === 'Manager') {
                                return '<span class="badge badge-info">Manager</span>';
                            } else {
                                return '<span class="badge badge-secondary">' + data + '</span>';
                            }
                        }
                    },
                    {
                        data: 'isActive',
                        name: 'isActive',
                        render: function (data, type, row) {
                            if (data) {
                                return '<span class="badge badge-success">Active</span>';
                            } else {
                                return '<span class="badge badge-secondary">Inactive</span>';
                            }
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            var actions = '<div class="btn-group btn-group-sm">';
                            actions += '<a href="/Admin/UserDetails/' + row.id + '" class="btn btn-outline-info" title="View Details"><i class="fas fa-eye"></i></a>';
                            actions += '<a href="/Admin/EditUser/' + row.id + '" class="btn btn-outline-primary" title="Edit"><i class="fas fa-edit"></i></a>';

                            if (row.isActive) {
                                actions += '<button onclick="deactivateUser(\'' + row.id + '\')" class="btn btn-outline-warning" title="Disable Access"><i class="fas fa-ban"></i></button>';
                            } else {
                                actions += '<button onclick="activateUser(\'' + row.id + '\')" class="btn btn-outline-success" title="Enable Access"><i class="fas fa-check"></i></button>';
                            }

                            if (!row.isDeleted) {
                                actions += '<button onclick="deleteUser(\'' + row.id + '\')" class="btn btn-outline-danger" title="Remove"><i class="fas fa-trash"></i></button>';
                            }

                            actions += '</div>';
                            return actions;
                        }
                    }
                ],
                order: [[0, 'asc']],
                language: {
                    processing: '<i class="fas fa-spinner fa-spin fa-2x"></i> Loading...',
                    emptyTable: 'No team members found',
                    zeroRecords: 'No matching records found'
                }
            });

            // Reload table when filter changes
            $('#filterStatus').change(function () {
                console.log('Filter changed to:', $(this).val());
                table.ajax.reload();
            });
        });

        function activateUser(id) {
            Swal.fire({
                title: 'Enable Access?',
                text: 'Enable access for this team member?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, enable',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("ActivateUser")', { id: id })
                        .done(function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                $('#usersTable').DataTable().ajax.reload();
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Error', 'An error occurred', 'error');
                        });
                }
            });
        }

        function deactivateUser(id) {
            Swal.fire({
                title: 'Disable Access?',
                text: 'This member will not be able to log in.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, disable',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("DeactivateUser")', { id: id })
                        .done(function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                $('#usersTable').DataTable().ajax.reload();
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Error', 'An error occurred', 'error');
                        });
                }
            });
        }

        function deleteUser(id) {
            Swal.fire({
                title: 'Remove Team Member?',
                text: 'This member will be delted. ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, remove',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("SoftDeleteUser")', { id: id })
                        .done(function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Removed!',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                $('#usersTable').DataTable().ajax.reload();
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Error', 'An error occurred', 'error');
                        });
                }
            });
        }
    </script>
}



