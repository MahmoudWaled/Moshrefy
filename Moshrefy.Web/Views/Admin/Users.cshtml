@model Moshrefy.Application.DTOs.Common.PaginatedResult<Moshrefy.Web.Models.User.UserVM>
@{
    ViewData["Title"] = "My Team";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentRole = ViewBag.CurrentRole as string ?? "all";
    var currentStatus = ViewBag.CurrentStatus as string ?? "all";
    var pageSize = Model.PageSize;
}

<!-- Page Header -->
<div class="bg-white p-4 mb-4 shadow-sm border-bottom">
    <div class="container-fluid">
        <div class="row align-items-center">

            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-2" style="--bs-breadcrumb-divider: 'â€º';">
                        <li class="breadcrumb-item">
                            <a asp-controller="Admin" asp-action="Index" class="text-decoration-none text-muted small">
                                <i class="bi bi-house-door me-1"></i> My Center
                            </a>
                        </li>
                        <li class="breadcrumb-item active small fw-medium text-primary" aria-current="page">
                            My Team
                        </li>
                    </ol>
                </nav>
                <div class="d-flex align-items-center">
                    <h2 class="h4 fw-bold text-secondary-emphasis mb-0 me-3">
                     <i class="bi bi-people me-2 fs-5"></i>   My Team
                    </h2>
                </div>
            </div>

            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="d-flex gap-2 justify-content-md-end">
                    <a asp-action="CreateUser" class="btn btn-success btn-sm px-3 shadow-sm">
                        <i class="bi bi-person-plus me-1"></i> Add New Member
                    </a>
                </div>
            </div>

        </div>
    </div>
</div>

@Html.AntiForgeryToken()

<!-- Page body -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                    <h3 class="card-title h5 mb-0 fw-semibold text-secondary-emphasis">
                        Team Members 
                    <span class="badge bg-primary  ">@Model.TotalCount members</span>

                    </h3>
                    <div class="d-flex gap-3 align-items-center flex-wrap">
                        <!-- Role Filter Buttons -->
                        <div class="btn-group" role="group" aria-label="Role filter">
                            <a asp-action="Users" asp-route-role="all" asp-route-status="@currentStatus" asp-route-pageSize="@pageSize"
                               class="btn btn-sm btn-outline-secondary border @(currentRole == "all" ? "active" : "")">
                                <i class="bi bi-list me-1"></i> All
                            </a>
                            <a asp-action="Users" asp-route-role="Employee" asp-route-status="@currentStatus" asp-route-pageSize="@pageSize"
                               class="btn btn-sm btn-outline-secondary border @(currentRole == "Employee" ? "active" : "")">
                                <i class="bi bi-person me-1"></i> Employees
                            </a>
                            <a asp-action="Users" asp-route-role="Manager" asp-route-status="@currentStatus" asp-route-pageSize="@pageSize"
                               class="btn btn-sm btn-outline-secondary border @(currentRole == "Manager" ? "active" : "")">
                                <i class="bi bi-person-gear me-1"></i> Managers
                            </a>
                        </div>
                        <!-- Status Filter Buttons -->
                        <div class="btn-group" role="group" aria-label="Status filter">
                            <a asp-action="Users" asp-route-role="@currentRole" asp-route-status="all" asp-route-pageSize="@pageSize"
                               class="btn btn-sm btn-outline-secondary border @(currentStatus == "all" ? "active" : "")">
                                <i class="bi bi-list me-1"></i> All
                            </a>
                            <a asp-action="Users" asp-route-role="@currentRole" asp-route-status="active" asp-route-pageSize="@pageSize"
                               class="btn btn-sm btn-outline-secondary border @(currentStatus == "active" ? "active" : "")">
                                Active
                            </a>
                            <a asp-action="Users" asp-route-role="@currentRole" asp-route-status="inactive" asp-route-pageSize="@pageSize"
                               class="btn btn-sm btn-outline-secondary border @(currentStatus == "inactive" ? "active" : "")">
                                Inactive
                            </a>
                        </div>
                        <!-- Page Size Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-list-ol me-1"></i> @pageSize per page
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item @(pageSize == 10 ? "active" : "")" asp-action="Users" asp-route-role="@currentRole" asp-route-status="@currentStatus" asp-route-pageSize="10">10 per page</a></li>
                                <li><a class="dropdown-item @(pageSize == 25 ? "active" : "")" asp-action="Users" asp-route-role="@currentRole" asp-route-status="@currentStatus" asp-route-pageSize="25">25 per page</a></li>
                                <li><a class="dropdown-item @(pageSize == 50 ? "active" : "")" asp-action="Users" asp-route-role="@currentRole" asp-route-status="@currentStatus" asp-route-pageSize="50">50 per page</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-3">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="usersTable">
                        <thead class="table-primary">
                            <tr>
                                <th>#</th>
                                <th>@Html.DisplayNameFor(m => m.Items.First().Name)</th>
                                <th>@Html.DisplayNameFor(m => m.Items.First().UserName)</th>
                                <th>@Html.DisplayNameFor(m => m.Items.First().Email)</th>
                                <th>@Html.DisplayNameFor(m => m.Items.First().PhoneNumber)</th>
                                <th>Type</th>
                                <th>@Html.DisplayNameFor(m => m.Items.First().IsActive)</th>
                                <th>Created</th>
                                <th class="w-1">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Items.Any())
                            {
                                var rowNumber = (Model.PageNumber - 1) * Model.PageSize;
                                @foreach (var user in Model.Items)
                                {
                                    rowNumber++;
                                    <tr>
                                        <td class="text-muted">@rowNumber</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="d-flex align-items-center justify-content-center bg-primary-subtle text-primary rounded-circle me-2" style="width: 32px; height: 32px;">
                                                    <i class="bi bi-person"></i>
                                                </span>
                                                <span class="text-secondary-emphasis">@user.Name</span>
                                            </div>
                                        </td>
                                        <td class="text-muted">@user.UserName</td>
                                        <td class="text-muted">@(user.Email ?? "N/A")</td>
                                        <td class="text-muted">@(user.PhoneNumber ?? "N/A")</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(user.RoleName))
                                            {
                                                <span class="text-muted">@user.RoleName</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">N/A</span>
                                            }
                                        </td>
                                        <td>
                                            @if (user.IsActive)
                                            {
                                                <span class="text-muted">Active</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Inactive</span>
                                            }
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <i class="bi bi-clock me-1"></i>@user.CreatedAt.ToString("MMM dd, yyyy")
                                            </small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a asp-action="UserDetails" asp-route-id="@user.Id" class="btn btn-sm btn-light" title="View Details">
                                                    <i class="bi bi-eye"></i>
                                                    view
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="9" class="text-center py-5">
                                        <i class="bi bi-people fs-1 text-muted d-block mb-3"></i>
                                        <p class="text-muted mb-2">No team members found</p>
                                        <a asp-action="CreateUser" class="btn btn-success btn-sm">
                                            <i class="bi bi-person-plus me-1"></i> Add New Member
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination Footer -->
            @if (Model.TotalPages > 1)
            {
                <div class="card-footer bg-white">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                                <a class="page-link" asp-action="Users" asp-route-page="@(Model.PageNumber - 1)" asp-route-pageSize="@pageSize" asp-route-role="@currentRole" asp-route-status="@currentStatus">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                    <a class="page-link" asp-action="Users" asp-route-page="@i" asp-route-pageSize="@pageSize" asp-route-role="@currentRole" asp-route-status="@currentStatus">@i</a>
                                </li>
                            }
                            <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                                <a class="page-link" asp-action="Users" asp-route-page="@(Model.PageNumber + 1)" asp-route-pageSize="@pageSize" asp-route-role="@currentRole" asp-route-status="@currentStatus">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</div>

@await Html.PartialAsync("_Modals")
@await Html.PartialAsync("_Toast")

@section Scripts {
    <script>
        const token = $('input[name="__RequestVerificationToken"]').val();

        function activateUser(id) {
            setupModal({
                title: 'Enable Access?',
                body: 'Enable access for this team member?',
                btnClass: 'btn-success',
                btnText: 'Yes, Enable',
                showInput: false,
                onConfirm: () => {
                    $.post('@Url.Action("ActivateUser")', { id: id, __RequestVerificationToken: token })
                        .done(function (res) {
                            if (res.success) {
                                showAlert('success', res.message);
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showAlert('error', res.message);
                            }
                        })
                        .fail(function () {
                            showAlert('error', 'An error occurred');
                        });
                }
            });
        }

        function deactivateUser(id) {
            setupModal({
                title: 'Disable Access?',
                body: 'This member will not be able to log in.',
                btnClass: 'btn-warning',
                btnText: 'Yes, Disable',
                showInput: false,
                onConfirm: () => {
                    $.post('@Url.Action("DeactivateUser")', { id: id, __RequestVerificationToken: token })
                        .done(function (res) {
                            if (res.success) {
                                showAlert('success', res.message);
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showAlert('error', res.message);
                            }
                        })
                        .fail(function () {
                            showAlert('error', 'An error occurred');
                        });
                }
            });
        }

        function deleteUser(id) {
            setupModal({
                title: 'Remove Team Member?',
                body: 'This action cannot be undone.<br><br>Type <strong>Delete</strong> to confirm:',
                btnClass: 'btn-danger',
                btnText: 'Remove',
                showInput: true,
                inputPlaceholder: 'Type Delete here',
                onConfirm: (inputVal) => {
                    if (inputVal !== 'Delete') {
                        showAlert('error', 'Please type "Delete" to confirm');
                        return;
                    }
                    $.post('@Url.Action("SoftDeleteUser")', { id: id, __RequestVerificationToken: token })
                        .done(function (res) {
                            if (res.success) {
                                showAlert('success', res.message);
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showAlert('error', res.message);
                            }
                        })
                        .fail(function () {
                            showAlert('error', 'An error occurred');
                        });
                }
            });
        }
    </script>
}
