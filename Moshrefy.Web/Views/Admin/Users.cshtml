@{
    ViewData["Title"] = "My Team";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page header -->
<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">Admin</div>
        <h2 class="page-title">My Team</h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
          <a asp-action="CreateUser" class="btn btn-action-create d-none d-sm-inline-block">
            <i class="ti ti-user-plus icon"></i>
            Add New Member
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Team Members</h3>
            <div class="ms-auto d-flex gap-3 align-items-center">
              <!-- Role Type Filter Buttons -->
              <div class="btn-group" role="group" aria-label="Role filter">
                <button type="button" class="btn btn-outline-secondary btn-sm active" data-filter-role="all">All</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-filter-role="Employee">
                  <i class="ti ti-user"></i> Employees
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" data-filter-role="Manager">
                  <i class="ti ti-user-cog"></i> Managers
                </button>
              </div>
              <!-- Status Filter -->
              <select id="filterStatus" class="form-select form-select-sm" style="width: auto;">
                <option value="all">All Members</option>
                <option value="active">Active Members</option>
                <option value="inactive">Inactive Members</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="usersTable" class="table table-vcenter table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th class="w-1">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var currentRoleFilter = 'all';
            
            var table = $('#usersTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetUsersData")',
                    type: 'POST',
                    data: function (d) {
                        d.filterStatus = $('#filterStatus').val();
                        d.filterRole = currentRoleFilter;
                    },
                    error: function (xhr, error, thrown) {
                        console.error('DataTable Error:', error, thrown);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error Loading Data',
                            text: error + '. Check console for details.'
                        });
                    },
                    dataSrc: function(json) {
                        return json.data;
                    }
                },
                columns: [
                    { data: 'name', name: 'name' },
                    { data: 'userName', name: 'userName' },
                    { data: 'email', name: 'email', defaultContent: '' },
                    { data: 'phoneNumber', name: 'phoneNumber', defaultContent: '' },
                    {
                        data: 'roleName',
                        name: 'roleName',
                        render: function (data, type, row) {
                            if (data === 'Employee') {
                                return '<span class="badge bg-role-employee"><i class="ti ti-user"></i> Employee</span>';
                            } else if (data === 'Manager') {
                                return '<span class="badge bg-role-manager"><i class="ti ti-user-cog"></i> Manager</span>';
                            } else {
                                return '<span class="badge bg-secondary">' + data + '</span>';
                            }
                        }
                    },
                    {
                        data: 'isActive',
                        name: 'isActive',
                        render: function (data, type, row) {
                            if (data) {
                                return '<span class="badge bg-state-active"><i class="ti ti-check"></i> Active</span>';
                            } else {
                                return '<span class="badge bg-state-inactive"><i class="ti ti-x"></i> Inactive</span>';
                            }
                        }
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            var actions = '<div class="btn-group btn-group-sm">';
                            actions += '<a href="/Admin/UserDetails/' + row.id + '" class="btn btn-action-view" title="View Details"><i class="ti ti-eye"></i></a>';
                            actions += '<a href="/Admin/EditUser/' + row.id + '" class="btn btn-action-edit" title="Edit"><i class="ti ti-edit"></i></a>';

                            if (row.isActive) {
                                actions += '<button onclick="deactivateUser(\'' + row.id + '\')" class="btn btn-state-deactive" title="Disable Access"><i class="ti ti-ban"></i></button>';
                            } else {
                                actions += '<button onclick="activateUser(\'' + row.id + '\')" class="btn btn-state-active" title="Enable Access"><i class="ti ti-check"></i></button>';
                            }

                            if (!row.isDeleted) {
                                actions += '<button onclick="deleteUser(\'' + row.id + '\')" class="btn btn-action-delete" title="Remove"><i class="ti ti-trash"></i></button>';
                            }

                            actions += '</div>';
                            return actions;
                        }
                    }
                ],
                order: [[0, 'asc']],
                language: {
                    processing: '<i class="ti ti-loader"></i> Loading...',
                    emptyTable: 'No team members found',
                    zeroRecords: 'No matching records found'
                }
            });

            // Role filter button click handler
            $('[data-filter-role]').click(function() {
                $('[data-filter-role]').removeClass('active');
                $(this).addClass('active');
                currentRoleFilter = $(this).data('filter-role');
                table.ajax.reload();
            });

            // Reload table when status filter changes
            $('#filterStatus').change(function () {
                table.ajax.reload();
            });
        });

        function activateUser(id) {
            Swal.fire({
                title: 'Enable Access?',
                text: 'Enable access for this team member?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ti ti-check"></i> Yes, enable',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("ActivateUser")', { id: id })
                        .done(function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                $('#usersTable').DataTable().ajax.reload();
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Error', 'An error occurred', 'error');
                        });
                }
            });
        }

        function deactivateUser(id) {
            Swal.fire({
                title: 'Disable Access?',
                text: 'This member will not be able to log in.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ffc107',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ti ti-ban"></i> Yes, disable',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("DeactivateUser")', { id: id })
                        .done(function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Success!',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                $('#usersTable').DataTable().ajax.reload();
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Error', 'An error occurred', 'error');
                        });
                }
            });
        }

        function deleteUser(id) {
            Swal.fire({
                title: 'Remove Team Member?',
                html: 'This action cannot be undone.<br><br>Type <strong>Delete</strong> to confirm:',
                icon: 'warning',
                input: 'text',
                inputPlaceholder: 'Type Delete here',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '<i class="ti ti-trash"></i> Remove',
                cancelButtonText: 'Cancel',
                inputValidator: (value) => {
                    if (value !== 'Delete') {
                        return 'Please type "Delete" to confirm';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('@Url.Action("SoftDeleteUser")', { id: id })
                        .done(function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Removed!',
                                    text: response.message,
                                    timer: 2000,
                                    showConfirmButton: false
                                });
                                $('#usersTable').DataTable().ajax.reload();
                            } else {
                                Swal.fire('Error', response.message, 'error');
                            }
                        })
                        .fail(function () {
                            Swal.fire('Error', 'An error occurred', 'error');
                        });
                }
            });
        }
    </script>
}

