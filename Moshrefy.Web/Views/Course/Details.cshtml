@model Moshrefy.Web.Models.Course.CourseVM
@{
    ViewData["Title"] = "Course Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page Header -->
<div class="page-header-modern">
    <div class="row g-2 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb-modern">
                    <li class="breadcrumb-item">
                        <a asp-controller="Course" asp-action="Index"><i class="ti ti-book"></i> Courses</a>
                        <i class="ti ti-chevron-right breadcrumb-separator ms-2"></i>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
                </ol>
            </nav>
            <h2 class="page-title"><i class="ti ti-book"></i> @Model.Name</h2>
        </div>
        <div class="col-auto ms-auto">
            <button type="button" onclick="goBack()" class="btn">
                <i class="ti ti-arrow-left"></i> Back
            </button>
        </div>
    </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row">
      <!-- Main Content -->
      <div class="col-lg-8">
        <!-- Status Banner -->
        <div class="card mb-3 @(Model.IsActive ? "border-success" : "border-secondary")">
          <div class="card-body py-3">
            <div class="d-flex align-items-center">
              @if (Model.IsActive)
              {
                <span class="avatar bg-state-active text-white me-3">
                  <i class="ti ti-check"></i>
                </span>
                <div>
                  <h3 class="mb-0 text-success">Active Course</h3>
                  <small class="text-muted">This course is available for enrollment</small>
                </div>
              }
              else
              {
                <span class="avatar bg-state-inactive text-white me-3">
                  <i class="ti ti-x"></i>
                </span>
                <div>
                  <h3 class="mb-0 text-muted">Inactive Course</h3>
                  <small class="text-muted">This course is currently disabled</small>
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Course Information Card -->
        <div class="card mb-3">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <span class="avatar bg-primary text-white me-3">
                <i class="ti ti-book"></i>
              </span>
              <h3 class="card-title mb-0">Course Information</h3>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label text-muted small mb-1"><i class="ti ti-book me-1"></i> Course Name</label>
                <div class="h5 mb-0">@Model.Name</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Academic Year Card -->
        <div class="card mb-3">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <span class="avatar bg-info text-white me-3">
                <i class="ti ti-calendar"></i>
              </span>
              <h3 class="card-title mb-0">Academic Year</h3>
            </div>
          </div>
          <div class="card-body">
            <div class="d-flex align-items-center">
              @if (!string.IsNullOrEmpty(Model.AcademicYearName))
              {
                <a asp-controller="AcademicYear" asp-action="Details" asp-route-id="@Model.AcademicYearId" class="btn btn-outline-info btn-lg">
                  <i class="ti ti-calendar me-2"></i>@Model.AcademicYearName
                </a>
                <span class="text-muted ms-3">Click to view academic year details</span>
              }
              else
              {
                <span class="text-muted">No academic year assigned</span>
              }
            </div>
          </div>
        </div>

        <!-- Assigned Teachers Card -->
        <div class="card mb-3">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <span class="avatar bg-success text-white me-3">
                <i class="ti ti-user-check"></i>
              </span>
              <h3 class="card-title mb-0">Assigned Teachers</h3>
            </div>
          </div>
          <div class="card-body">
            <div id="assignedTeachersList">
              <div class="text-center text-muted py-3">
                <span class="spinner-border spinner-border-sm"></span> Loading...
              </div>
            </div>
          </div>
        </div>

        @* Enrolled Students Card *@
        <div class="card mb-3">
          <div class="card-header">
            <div class="row align-items-center">
              <div class="col">
                <div class="d-flex align-items-center">
                  <span class="avatar bg-azure text-white me-3">
                    <i class="ti ti-users"></i>
                  </span>
                  <h3 class="card-title mb-0">Enrolled Students</h3>
                </div>
              </div>
              @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
              {
                <div class="col-auto">
                  <button type="button" class="btn btn-success btn-sm" onclick="openBulkAddStudents()">
                    <i class="ti ti-plus me-1"></i> Add Students
                  </button>
                </div>
              }
            </div>
          </div>
          <div class="card-body">
            <div id="enrolledStudentsList">
              <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Loading students...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <!-- Actions Card -->
        <div class="card mb-3">
          <div class="card-header">
            <h3 class="card-title"><i class="ti ti-settings me-2"></i>Actions</h3>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-action-edit">
                <i class="ti ti-edit me-2"></i> Edit Course
              </a>
              @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
              {
                <a asp-controller="TeacherCourse" asp-action="Create" asp-route-courseId="@Model.Id" class="btn btn-primary">
                  <i class="ti ti-user-plus me-2"></i> Assign Teacher
                </a>
              }
              @if (Model.IsActive)
              {
                <button class="btn btn-state-deactive" onclick="deactivateCourse()">
                  <i class="ti ti-ban me-2"></i> Deactivate
                </button>
              }
              else
              {
                <button class="btn btn-state-active" onclick="activateCourse()">
                  <i class="ti ti-check me-2"></i> Activate
                </button>
              }
              <hr class="my-2">
              <button class="btn btn-outline-danger" onclick="deleteCourse()">
                <i class="ti ti-trash me-2"></i> Delete Course
              </button>
            </div>
          </div>
        </div>

        <!-- Info Card -->
        <div class="card bg-azure-lt">
          <div class="card-body">
            <div class="d-flex">
              <div>
                <i class="ti ti-info-circle icon text-azure me-2" style="font-size: 1.5rem;"></i>
              </div>
              <div>
                <h4 class="mb-1">About Courses</h4>
                <p class="text-muted mb-0 small">
                  Courses are organized by academic years. Students can enroll in active courses.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadAssignedTeachers();
        });

        function loadAssignedTeachers() {
            $.get('@Url.Action("GetAssignedTeachers")/@Model.Id', function(teachers) {
                var html = '';
                if (teachers.length === 0) {
                    html = '<div class="text-center text-muted py-2"><i class="ti ti-users-off me-1"></i> No teachers assigned</div>';
                } else {
                    html = '<ul class="list-group list-group-flush">';
                    teachers.forEach(function(t) {
                        html += '<li class="list-group-item d-flex align-items-center">';
                        html += '<i class="ti ti-user-check text-success me-2"></i>';
                        html += '<a href="/Teacher/ManageCourses/' + t.teacherId + '" class="text-decoration-none">' + t.teacherName + '</a>';
                        if (!t.isActive) {
                            html += ' <span class="badge bg-secondary ms-2">Inactive</span>';
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                }
                $('#assignedTeachersList').html(html);
            });
        }

        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '@Url.Action("Index", "Course")';
            }
        }
        
        function activateCourse() {
            TablerDialog.fire({ title: 'Activate Course?', text: 'Make this course available for enrollment?', icon: 'question', showCancelButton: true, confirmButtonColor: '#28a745', confirmButtonText: '<i class="ti ti-check"></i> Activate' })
            .then((r) => { if (r.isConfirmed) { $.post('@Url.Action("Activate")', { id: @Model.Id }).done((res) => { if (res.success) { TablerDialog.fire({ icon: 'success', title: 'Activated!', text: res.message, timer: 2000, showConfirmButton: false }).then(() => location.reload()); } else { TablerDialog.fire('Error', res.message, 'error'); } }).fail(() => TablerDialog.fire('Error', 'An error occurred', 'error')); } });
        }

        function deactivateCourse() {
            TablerDialog.fire({ title: 'Deactivate Course?', text: 'This will hide the course from enrollment.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ffc107', confirmButtonText: '<i class="ti ti-ban"></i> Deactivate' })
            .then((r) => { if (r.isConfirmed) { $.post('@Url.Action("Deactivate")', { id: @Model.Id }).done((res) => { if (res.success) { TablerDialog.fire({ icon: 'success', title: 'Deactivated!', text: res.message, timer: 2000, showConfirmButton: false }).then(() => location.reload()); } else { TablerDialog.fire('Error', res.message, 'error'); } }).fail(() => TablerDialog.fire('Error', 'An error occurred', 'error')); } });
        }

        function deleteCourse() {
            TablerDialog.fire({ 
                title: 'Delete Course?', 
                html: 'This action cannot be undone.<br><br>Type <strong>Delete</strong> to confirm:', 
                icon: 'error', 
                input: 'text',
                inputPlaceholder: 'Type Delete here',
                showCancelButton: true, 
                confirmButtonColor: '#dc3545', 
                confirmButtonText: '<i class="ti ti-trash"></i> Delete Forever',
                inputValidator: (value) => {
                    if (value !== 'Delete') {
                        return 'Please type "Delete" to confirm';
                    }
                }
            })
            .then((r) => { if (r.isConfirmed) { $.post('@Url.Action("Delete")', { id: @Model.Id }).done((res) => { if (res.success) { TablerDialog.fire({ icon: 'success', title: 'Deleted!', text: res.message, timer: 2000, showConfirmButton: false }).then(() => window.location.href = '@Url.Action("Index")'); } else { TablerDialog.fire('Error', res.message, 'error'); } }).fail(() => TablerDialog.fire('Error', 'An error occurred', 'error')); } });
        }

        // Load enrolled students
        $(document).ready(function() {
            loadEnrolledStudents();
        });

        function loadEnrolledStudents() {
            $.get('/Course/GetEnrolledStudents/@Model.Id', function(data) {
                if (data.length === 0) {
                    $('#enrolledStudentsList').html('<p class="text-muted mb-0">No students enrolled yet.</p>');
                } else {
                    let html = '<div class="list-group list-group-flush">';
                    data.forEach(function(enrollment) {
                        const statusBadge = enrollment.isActive ? '<span class="badge bg-state-active ms-2">Active</span>' : '<span class="badge bg-state-inactive ms-2">Inactive</span>';
                        html += `<a href="/Student/Details/${enrollment.studentId}" class="list-group-item list-group-item-action"><div class="d-flex align-items-center"><span class="avatar bg-azure text-white me-3"><i class="ti ti-user"></i></span><div class="flex-fill"><strong>${enrollment.studentName}</strong></div>${statusBadge}</div></a>`;
                    });
                    html += '</div>';
                    $('#enrolledStudentsList').html(html);
                }
            });
        }

        // Open bulk add students modal
        function openBulkAddStudents() {
            $.get('/Enrollment/GetAvailableStudentsForCourse/@Model.Id', function(data) {
                if (data.length === 0) {
                    TablerDialog.fire('Info', 'No available students to enroll.', 'info');
                    return;
                }
                let studentsHtml = '<div class="mb-3"><input type="text" class="form-control" id="studentSearch" placeholder="Search students..."></div><div id="studentsList" style="max-height: 400px; overflow-y: auto;">';
                data.forEach(function(student) {
                    studentsHtml += `<div class="form-check student-item"><input class="form-check-input student-check" type="checkbox" value="${student.id}" id="student${student.id}"><label class="form-check-label" for="student${student.id}">${student.name}</label></div>`;
                });
                studentsHtml += '</div>';
                TablerDialog.fire({ title: 'Add Students to Course', html: studentsHtml, width: '500px', showCancelButton: true, confirmButtonText: '<i class="ti ti-check"></i> Enroll', didOpen: () => { $('#studentSearch').on('input', function() { const search = $(this).val().toLowerCase(); $('.student-item').each(function() { const text = $(this).text().toLowerCase(); $(this).toggle(text.includes(search)); }); }); }, preConfirm: () => { const selected = $('.student-check:checked').map(function() { return parseInt($(this).val()); }).get(); if (selected.length === 0) { TablerDialog.showValidationMessage('Please select at least one student'); return false; } return selected; } }).then((result) => { if (result.isConfirmed) { $.ajax({ url: '/Enrollment/BulkEnrollStudentsInCourse', type: 'POST', contentType: 'application/json', data: JSON.stringify({ courseId: @Model.Id, studentIds: result.value }), success: function(res) { if (res.success) { TablerDialog.fire({ icon: 'success', title: 'Success!', text: res.message, timer: 2000, showConfirmButton: false }).then(() => loadEnrolledStudents()); } else { TablerDialog.fire('Error', res.message, 'error'); } }, error: function() { TablerDialog.fire('Error', 'An error occurred.', 'error'); } }); } });
            });
        }
    </script>
}
