@{
    ViewData["Title"] = "Courses";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Page Header -->
<div class="page-header-modern">
    <div class="row g-2 align-items-center">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb-modern">
                    <li class="breadcrumb-item active" aria-current="page"><i class="ti ti-book"></i> Courses</li>
                </ol>
            </nav>
            <h2 class="page-title"><i class="ti ti-book"></i> Courses</h2>
        </div>
        <div class="col-auto ms-auto d-print-none">
            @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
            {
                <a asp-action="Create" class="btn btn-action-create d-none d-sm-inline-block">
                    <i class="ti ti-plus icon"></i> Add Course
                </a>
            }
        </div>
    </div>
</div>

<!-- Page body -->
<div class="page-body">
  <div class="container-xl">
    <div class="row row-deck row-cards">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Manage Courses</h3>
            <div class="ms-auto">
              <select id="filterStatus" class="form-select form-select-sm" style="width: auto;">
                <option value="all">All Courses</option>
                <option value="active">Active Only</option>
                <option value="inactive">Inactive Only</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="coursesTable" class="table table-vcenter table-hover">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Course Name</th>
                    <th>Academic Year</th>
                    <th>Status</th>
                    <th>Created At</th>
                    <th class="w-1">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var table = $('#coursesTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '@Url.Action("GetCoursesData")',
                    type: 'POST',
                    data: function (d) { d.filterStatus = $('#filterStatus').val(); },
                    error: function () { Swal.fire({ icon: 'error', title: 'Error Loading Data' }); },
                    dataSrc: function(json) { return json.data; }
                },
                columns: [
                    {
                        data: null,
                        orderable: false,
                        searchable: false,
                        width: '50px',
                        className: 'text-center',
                        render: function(data, type, row, meta) {
                            return '<span class="text-muted">' + (meta.row + meta.settings._iDisplayStart + 1) + '</span>';
                        }
                    },
                    { data: 'name', name: 'name' },
                    { data: 'academicYearName', name: 'academicYearName', defaultContent: '<span class="text-muted">N/A</span>' },
                    {
                        data: 'isActive', name: 'isActive',
                        render: function (d) {
                            return d ? '<span class="text-muted">Active</span>' : '<span class="badge bg-state-inactive text-white"><i class="ti ti-x"></i> Inactive</span>';
                        }
                    },
                    {
                        data: 'createdAt', name: 'createdAt',
                        className: 'text-center',
                        render: function(data) {
                            if (!data) return '<span class="text-muted">N/A</span>';
                            var date = new Date(data);
                            return '<small class="text-muted"><i class="ti ti-clock me-1"></i>' + date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) + '</small>';
                        }
                    },
                    {
                        data: null, orderable: false,
                        render: function (d, t, row) {
                            var a = '<div class="btn-group btn-group-sm">';
                            a += '<a href="/Course/Details/' + row.id + '" class="btn btn-action-icon action-view" title="View"><i class="ti ti-eye"></i></a>';
                            @if (User.IsInRole("Admin") || User.IsInRole("Manager"))
                            {
                                @:a += '<a href="/Course/Edit/' + row.id + '" class="btn btn-action-icon action-edit" title="Edit"><i class="ti ti-edit"></i></a>';
                                @:if (row.isActive) { a += '<button onclick="deactivateCourse(' + row.id + ')" class="btn btn-action-icon action-deactivate" title="Deactivate"><i class="ti ti-ban"></i></button>'; }
                                @:else { a += '<button onclick="activateCourse(' + row.id + ')" class="btn btn-action-icon action-activate" title="Activate"><i class="ti ti-check"></i></button>'; }
                            }
                            @if (User.IsInRole("Admin"))
                            {
                                @:a += '<button onclick="deleteCourse(' + row.id + ')" class="btn btn-action-icon action-delete" title="Delete"><i class="ti ti-trash"></i></button>';
                            }
                            return a + '</div>';
                        }
                    }

                ],
                order: [[5, 'desc']],
                language: {
                    search: '_INPUT_',
                    searchPlaceholder: 'Search courses...',
                    lengthMenu: '_MENU_ entries',
                    info: 'Showing _START_ to _END_ of _TOTAL_ courses',
                    infoEmpty: 'No courses found',
                    infoFiltered: '(from _MAX_ total)',
                    zeroRecords: 'No matching courses found',
                    paginate: { first: '«', last: '»', next: '›', previous: '‹' }
                }
            });

            $('#filterStatus').change(function () { table.ajax.reload(); });
        });

        function activateCourse(id) {
            Swal.fire({ title: 'Activate Course?', text: 'This course will be available for enrollment.', icon: 'question', showCancelButton: true, confirmButtonColor: '#28a745', confirmButtonText: '<i class="ti ti-check"></i> Yes, activate' })
            .then((r) => { if (r.isConfirmed) { $.post('@Url.Action("Activate")', { id: id }).done((res) => { if (res.success) { Swal.fire({ icon: 'success', title: 'Activated!', timer: 2000, showConfirmButton: false }); $('#coursesTable').DataTable().ajax.reload(); } else { Swal.fire('Error', res.message, 'error'); } }); } });
        }

        function deactivateCourse(id) {
            Swal.fire({ title: 'Deactivate Course?', text: 'This course will not be available.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ffc107', confirmButtonText: '<i class="ti ti-ban"></i> Yes, deactivate' })
            .then((r) => { if (r.isConfirmed) { $.post('@Url.Action("Deactivate")', { id: id }).done((res) => { if (res.success) { Swal.fire({ icon: 'success', title: 'Deactivated!', timer: 2000, showConfirmButton: false }); $('#coursesTable').DataTable().ajax.reload(); } else { Swal.fire('Error', res.message, 'error'); } }); } });
        }

        function deleteCourse(id) {
            Swal.fire({ title: 'Delete Course?', text: 'This will permanently delete this course.', icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: '<i class="ti ti-trash"></i> Yes, delete' })
            .then((r) => { if (r.isConfirmed) { $.post('@Url.Action("Delete")', { id: id }).done((res) => { if (res.success) { Swal.fire({ icon: 'success', title: 'Deleted!', timer: 2000, showConfirmButton: false }); $('#coursesTable').DataTable().ajax.reload(); } else { Swal.fire('Error', res.message, 'error'); } }); } });
        }
    </script>
}
